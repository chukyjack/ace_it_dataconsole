/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { isEmpty } from './isEmpty';
import { setEntities } from './setEntities';
import { Store } from './store';
import { getActiveEntities } from './getActiveEntities';
import { addEntities } from './addEntities';
import { coerceArray } from './coerceArray';
import { removeEntities } from './removeEntities';
import { getInitialEntitiesState } from './getInitialEntitiesState';
import { isDefined } from './isDefined';
import { updateEntities } from './updateEntities';
import { transaction } from './transaction';
import { isNil } from './isNil';
import { isFunction } from './isFunction';
import { isUndefined } from './isUndefined';
import { logAction, setAction } from './actions';
import { isDev } from './env';
import { hasEntity } from './hasEntity';
import { Subject } from 'rxjs';
import { EntityActions } from './entityActions';
import { DEFAULT_ID_KEY } from './defaultIDKey';
/**
 *
 * Store for managing a collection of entities
 *
 * \@example
 *
 * export interface WidgetsState extends EntityState<Widget> { }
 *
 * \@StoreConfig({ name: 'widgets' })
 *  export class WidgetsStore extends EntityStore<WidgetsState> {
 *   constructor() {
 *     super();
 *   }
 * }
 *
 *
 * @template S, EntityType, IDType
 */
var EntityStore = /** @class */ (function (_super) {
    tslib_1.__extends(EntityStore, _super);
    function EntityStore(initialState, options) {
        if (initialState === void 0) { initialState = {}; }
        if (options === void 0) { options = {}; }
        var _this = _super.call(this, tslib_1.__assign({}, getInitialEntitiesState(), initialState), options) || this;
        _this.options = options;
        _this.entityActions = new Subject();
        return _this;
    }
    Object.defineProperty(EntityStore.prototype, "selectEntityAction$", {
        // @internal
        get: 
        // @internal
        /**
         * @return {?}
         */
        function () {
            return this.entityActions.asObservable();
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(EntityStore.prototype, "idKey", {
        // @internal
        get: 
        // @internal
        /**
         * @return {?}
         */
        function () {
            return ((/** @type {?} */ (this.config))).idKey || this.options.idKey || DEFAULT_ID_KEY;
        },
        enumerable: true,
        configurable: true
    });
    /**
     *
     * Replace current collection with provided collection
     *
     * @example
     *
     * this.store.set([Entity, Entity])
     * this.store.set({ids: [], entities: {}})
     * this.store.set({ 1: {}, 2: {}})
     *
     */
    /**
     *
     * Replace current collection with provided collection
     *
     * \@example
     *
     * this.store.set([Entity, Entity])
     * this.store.set({ids: [], entities: {}})
     * this.store.set({ 1: {}, 2: {}})
     *
     * @param {?} entities
     * @return {?}
     */
    EntityStore.prototype.set = /**
     *
     * Replace current collection with provided collection
     *
     * \@example
     *
     * this.store.set([Entity, Entity])
     * this.store.set({ids: [], entities: {}})
     * this.store.set({ 1: {}, 2: {}})
     *
     * @param {?} entities
     * @return {?}
     */
    function (entities) {
        var _this = this;
        if (isNil(entities))
            return;
        isDev() && setAction('Set Entity');
        /** @type {?} */
        var isNativePreAdd = this.akitaPreAddEntity === EntityStore.prototype.akitaPreAddEntity;
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        function (state) {
            return setEntities({
                state: state,
                entities: entities,
                idKey: _this.idKey,
                preAddEntity: _this.akitaPreAddEntity,
                isNativePreAdd: isNativePreAdd
            });
        }));
        this.setHasCache(true, { restartTTL: true });
        if (this.hasInitialUIState()) {
            this.handleUICreation();
        }
        this.entityActions.next({ type: EntityActions.Set, ids: this.ids });
    };
    /**
     * Add entities
     *
     * @example
     *
     * this.store.add([Entity, Entity])
     * this.store.add(Entity)
     * this.store.add(Entity, { prepend: true })
     *
     * this.store.add(Entity, { loading: false })
     */
    /**
     * Add entities
     *
     * \@example
     *
     * this.store.add([Entity, Entity])
     * this.store.add(Entity)
     * this.store.add(Entity, { prepend: true })
     *
     * this.store.add(Entity, { loading: false })
     * @param {?} entities
     * @param {?=} options
     * @return {?}
     */
    EntityStore.prototype.add = /**
     * Add entities
     *
     * \@example
     *
     * this.store.add([Entity, Entity])
     * this.store.add(Entity)
     * this.store.add(Entity, { prepend: true })
     *
     * this.store.add(Entity, { loading: false })
     * @param {?} entities
     * @param {?=} options
     * @return {?}
     */
    function (entities, options) {
        if (options === void 0) { options = { loading: false }; }
        /** @type {?} */
        var collection = coerceArray(entities);
        if (isEmpty(collection))
            return;
        /** @type {?} */
        var data = addEntities({
            state: this._value(),
            preAddEntity: this.akitaPreAddEntity,
            entities: collection,
            idKey: this.idKey,
            options: options
        });
        if (data) {
            isDev() && setAction('Add Entity');
            data.newState.loading = options.loading;
            this._setState((/**
             * @return {?}
             */
            function () { return data.newState; }));
            if (this.hasInitialUIState()) {
                this.handleUICreation(true);
            }
            this.entityActions.next({ type: EntityActions.Add, ids: data.newIds });
        }
    };
    /**
     * @param {?} idsOrFnOrState
     * @param {?=} newStateOrFn
     * @return {?}
     */
    EntityStore.prototype.update = /**
     * @param {?} idsOrFnOrState
     * @param {?=} newStateOrFn
     * @return {?}
     */
    function (idsOrFnOrState, newStateOrFn) {
        var _this = this;
        if (isUndefined(newStateOrFn)) {
            _super.prototype.update.call(this, (/** @type {?} */ (idsOrFnOrState)));
            return;
        }
        /** @type {?} */
        var ids = [];
        if (isFunction(idsOrFnOrState)) {
            // We need to filter according the predicate function
            ids = this.ids.filter((/**
             * @param {?} id
             * @return {?}
             */
            function (id) { return ((/** @type {?} */ (idsOrFnOrState)))(_this.entities[id]); }));
        }
        else {
            // If it's nil we want all of them
            ids = isNil(idsOrFnOrState) ? this.ids : coerceArray((/** @type {?} */ (idsOrFnOrState)));
        }
        if (isEmpty(ids))
            return;
        isDev() && setAction('Update Entity', ids);
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        function (state) {
            return updateEntities({
                idKey: _this.idKey,
                ids: ids,
                preUpdateEntity: _this.akitaPreUpdateEntity,
                state: state,
                newStateOrFn: newStateOrFn,
                producerFn: _this._producerFn
            });
        }));
        this.entityActions.next({ type: EntityActions.Update, ids: ids });
    };
    /**
     *
     * Create or update
     *
     * @example
     *
     * store.upsert(1, { active: true })
     * store.upsert([2, 3], { active: true })
     * store.upsert([2, 3], entity => ({ isOpen: !entity.isOpen}))
     *
     */
    /**
     *
     * Create or update
     *
     * \@example
     *
     * store.upsert(1, { active: true })
     * store.upsert([2, 3], { active: true })
     * store.upsert([2, 3], entity => ({ isOpen: !entity.isOpen}))
     *
     * @param {?} ids
     * @param {?} newState
     * @param {?=} options
     * @return {?}
     */
    EntityStore.prototype.upsert = /**
     *
     * Create or update
     *
     * \@example
     *
     * store.upsert(1, { active: true })
     * store.upsert([2, 3], { active: true })
     * store.upsert([2, 3], entity => ({ isOpen: !entity.isOpen}))
     *
     * @param {?} ids
     * @param {?} newState
     * @param {?=} options
     * @return {?}
     */
    function (ids, newState, options) {
        var _this = this;
        if (options === void 0) { options = {}; }
        /** @type {?} */
        var toArray = coerceArray(ids);
        /** @type {?} */
        var predicate = (/**
         * @param {?} isUpdate
         * @return {?}
         */
        function (isUpdate) { return (/**
         * @param {?} id
         * @return {?}
         */
        function (id) { return hasEntity(_this.entities, id) === isUpdate; }); });
        /** @type {?} */
        var isClassBased = isFunction(options.baseClass);
        /** @type {?} */
        var updateIds = toArray.filter(predicate(true));
        /** @type {?} */
        var newEntities = toArray.filter(predicate(false)).map((/**
         * @param {?} id
         * @return {?}
         */
        function (id) {
            var _a;
            /** @type {?} */
            var entity = isFunction(newState) ? newState((/** @type {?} */ ({}))) : newState;
            /** @type {?} */
            var withId = tslib_1.__assign({}, ((/** @type {?} */ (entity))), (_a = {}, _a[_this.idKey] = id, _a));
            if (isClassBased) {
                return new options.baseClass(withId);
            }
            return withId;
        }));
        // it can be any of the three types
        this.update((/** @type {?} */ (updateIds)), (/** @type {?} */ (newState)));
        this.add(newEntities);
        isDev() && logAction('Upsert Entity');
    };
    /**
     *
     * Upsert entity collection (idKey must be present)
     *
     * @example
     *
     * store.upsertMany([ { id: 1 }, { id: 2 }]);
     *
     * store.upsertMany([ { id: 1 }, { id: 2 }], { loading: true  });
     * store.upsertMany([ { id: 1 }, { id: 2 }], { baseClass: Todo  });
     *
     */
    /**
     *
     * Upsert entity collection (idKey must be present)
     *
     * \@example
     *
     * store.upsertMany([ { id: 1 }, { id: 2 }]);
     *
     * store.upsertMany([ { id: 1 }, { id: 2 }], { loading: true  });
     * store.upsertMany([ { id: 1 }, { id: 2 }], { baseClass: Todo  });
     *
     * @param {?} entities
     * @param {?=} options
     * @return {?}
     */
    EntityStore.prototype.upsertMany = /**
     *
     * Upsert entity collection (idKey must be present)
     *
     * \@example
     *
     * store.upsertMany([ { id: 1 }, { id: 2 }]);
     *
     * store.upsertMany([ { id: 1 }, { id: 2 }], { loading: true  });
     * store.upsertMany([ { id: 1 }, { id: 2 }], { baseClass: Todo  });
     *
     * @param {?} entities
     * @param {?=} options
     * @return {?}
     */
    function (entities, options) {
        if (options === void 0) { options = {}; }
        var e_1, _a;
        /** @type {?} */
        var addedIds = [];
        /** @type {?} */
        var updatedIds = [];
        /** @type {?} */
        var updatedEntities = {};
        try {
            // Update the state directly to optimize performance
            for (var entities_1 = tslib_1.__values(entities), entities_1_1 = entities_1.next(); !entities_1_1.done; entities_1_1 = entities_1.next()) {
                var entity = entities_1_1.value;
                /** @type {?} */
                var withPreCheckHook = this.akitaPreCheckEntity(entity);
                /** @type {?} */
                var id = withPreCheckHook[this.idKey];
                if (hasEntity(this.entities, id)) {
                    /** @type {?} */
                    var prev = this._value().entities[id];
                    /** @type {?} */
                    var merged = tslib_1.__assign({}, this._value().entities[id], withPreCheckHook);
                    /** @type {?} */
                    var next = options.baseClass ? new options.baseClass(merged) : merged;
                    /** @type {?} */
                    var withHook = this.akitaPreUpdateEntity(prev, next);
                    /** @type {?} */
                    var nextId = withHook[this.idKey];
                    updatedEntities[nextId] = withHook;
                    updatedIds.push(nextId);
                }
                else {
                    /** @type {?} */
                    var newEntity = options.baseClass ? new options.baseClass(withPreCheckHook) : withPreCheckHook;
                    /** @type {?} */
                    var withHook = this.akitaPreAddEntity(newEntity);
                    /** @type {?} */
                    var nextId = withHook[this.idKey];
                    addedIds.push(nextId);
                    updatedEntities[nextId] = withHook;
                }
            }
        }
        catch (e_1_1) { e_1 = { error: e_1_1 }; }
        finally {
            try {
                if (entities_1_1 && !entities_1_1.done && (_a = entities_1.return)) _a.call(entities_1);
            }
            finally { if (e_1) throw e_1.error; }
        }
        isDev() && logAction('Upsert Many');
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        function (state) { return (tslib_1.__assign({}, state, { ids: addedIds.length ? tslib_1.__spread(state.ids, addedIds) : state.ids, entities: tslib_1.__assign({}, state.entities, updatedEntities), loading: !!options.loading })); }));
        updatedIds.length && this.entityActions.next({ type: EntityActions.Update, ids: updatedIds });
        addedIds.length && this.entityActions.next({ type: EntityActions.Add, ids: addedIds });
        if (addedIds.length && this.hasUIStore()) {
            this.handleUICreation(true);
        }
    };
    /**
     *
     * Replace one or more entities (except the id property)
     *
     *
     * @example
     *
     * this.store.replace(5, newEntity)
     * this.store.replace([1,2,3], newEntity)
     */
    /**
     *
     * Replace one or more entities (except the id property)
     *
     *
     * \@example
     *
     * this.store.replace(5, newEntity)
     * this.store.replace([1,2,3], newEntity)
     * @param {?} ids
     * @param {?} newState
     * @return {?}
     */
    EntityStore.prototype.replace = /**
     *
     * Replace one or more entities (except the id property)
     *
     *
     * \@example
     *
     * this.store.replace(5, newEntity)
     * this.store.replace([1,2,3], newEntity)
     * @param {?} ids
     * @param {?} newState
     * @return {?}
     */
    function (ids, newState) {
        var e_2, _a;
        /** @type {?} */
        var toArray = coerceArray(ids);
        if (isEmpty(toArray))
            return;
        /** @type {?} */
        var replaced = {};
        try {
            for (var toArray_1 = tslib_1.__values(toArray), toArray_1_1 = toArray_1.next(); !toArray_1_1.done; toArray_1_1 = toArray_1.next()) {
                var id = toArray_1_1.value;
                newState[this.idKey] = id;
                replaced[id] = newState;
            }
        }
        catch (e_2_1) { e_2 = { error: e_2_1 }; }
        finally {
            try {
                if (toArray_1_1 && !toArray_1_1.done && (_a = toArray_1.return)) _a.call(toArray_1);
            }
            finally { if (e_2) throw e_2.error; }
        }
        isDev() && setAction('Replace Entity', ids);
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        function (state) { return (tslib_1.__assign({}, state, { entities: tslib_1.__assign({}, state.entities, replaced) })); }));
    };
    /**
     *
     * Move entity inside the collection
     *
     *
     * @example
     *
     * this.store.move(fromIndex, toIndex)
     */
    /**
     *
     * Move entity inside the collection
     *
     *
     * \@example
     *
     * this.store.move(fromIndex, toIndex)
     * @param {?} from
     * @param {?} to
     * @return {?}
     */
    EntityStore.prototype.move = /**
     *
     * Move entity inside the collection
     *
     *
     * \@example
     *
     * this.store.move(fromIndex, toIndex)
     * @param {?} from
     * @param {?} to
     * @return {?}
     */
    function (from, to) {
        /** @type {?} */
        var ids = this.ids.slice();
        ids.splice(to < 0 ? ids.length + to : to, 0, ids.splice(from, 1)[0]);
        isDev() && setAction('Move Entity');
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        function (state) { return (tslib_1.__assign({}, state, { entities: tslib_1.__assign({}, state.entities), ids: ids })); }));
    };
    /**
     * @param {?=} idsOrFn
     * @return {?}
     */
    EntityStore.prototype.remove = /**
     * @param {?=} idsOrFn
     * @return {?}
     */
    function (idsOrFn) {
        var _this = this;
        if (isEmpty(this.ids))
            return;
        /** @type {?} */
        var idPassed = isDefined(idsOrFn);
        // null means remove all
        /** @type {?} */
        var ids = [];
        if (isFunction(idsOrFn)) {
            ids = this.ids.filter((/**
             * @param {?} entityId
             * @return {?}
             */
            function (entityId) { return idsOrFn(_this.entities[entityId]); }));
        }
        else {
            ids = idPassed ? coerceArray(idsOrFn) : null;
        }
        if (isEmpty(ids))
            return;
        isDev() && setAction('Remove Entity', ids);
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        function (state) { return removeEntities({ state: state, ids: ids }); }));
        if (ids === null) {
            this.setHasCache(false);
        }
        this.handleUIRemove(ids);
        this.entityActions.next({ type: EntityActions.Remove, ids: ids });
    };
    /**
     *
     * Update the active entity
     *
     * @example
     *
     * this.store.updateActive({ completed: true })
     * this.store.updateActive(active => {
     *   return {
     *     config: {
     *      ..active.config,
     *      date
     *     }
     *   }
     * })
     */
    /**
     *
     * Update the active entity
     *
     * \@example
     *
     * this.store.updateActive({ completed: true })
     * this.store.updateActive(active => {
     *   return {
     *     config: {
     *      ..active.config,
     *      date
     *     }
     *   }
     * })
     * @param {?} newStateOrCallback
     * @return {?}
     */
    EntityStore.prototype.updateActive = /**
     *
     * Update the active entity
     *
     * \@example
     *
     * this.store.updateActive({ completed: true })
     * this.store.updateActive(active => {
     *   return {
     *     config: {
     *      ..active.config,
     *      date
     *     }
     *   }
     * })
     * @param {?} newStateOrCallback
     * @return {?}
     */
    function (newStateOrCallback) {
        /** @type {?} */
        var ids = coerceArray(this.active);
        isDev() && setAction('Update Active', ids);
        this.update(ids, (/** @type {?} */ (newStateOrCallback)));
    };
    /**
     * @param {?} idOrOptions
     * @return {?}
     */
    EntityStore.prototype.setActive = /**
     * @param {?} idOrOptions
     * @return {?}
     */
    function (idOrOptions) {
        /** @type {?} */
        var active = getActiveEntities(idOrOptions, this.ids, this.active);
        if (active === undefined) {
            return;
        }
        isDev() && setAction('Set Active', active);
        this._setActive(active);
    };
    /**
     * Add active entities
     *
     * @example
     *
     * store.addActive(2);
     * store.addActive([3, 4, 5]);
     */
    /**
     * Add active entities
     *
     * \@example
     *
     * store.addActive(2);
     * store.addActive([3, 4, 5]);
     * @template T
     * @param {?} ids
     * @return {?}
     */
    EntityStore.prototype.addActive = /**
     * Add active entities
     *
     * \@example
     *
     * store.addActive(2);
     * store.addActive([3, 4, 5]);
     * @template T
     * @param {?} ids
     * @return {?}
     */
    function (ids) {
        var _this = this;
        /** @type {?} */
        var toArray = coerceArray(ids);
        if (isEmpty(toArray))
            return;
        /** @type {?} */
        var everyExist = toArray.every((/**
         * @param {?} id
         * @return {?}
         */
        function (id) { return _this.active.indexOf(id) > -1; }));
        if (everyExist)
            return;
        isDev() && setAction('Add Active', ids);
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        function (state) {
            /**
             * Protect against case that one of the items in the array exist
             * @type {?}
             */
            var uniques = Array.from(new Set(tslib_1.__spread(((/** @type {?} */ (state.active))), toArray)));
            return tslib_1.__assign({}, state, { active: uniques });
        }));
    };
    /**
     * Remove active entities
     *
     * @example
     *
     * store.removeActive(2)
     * store.removeActive([3, 4, 5])
     */
    /**
     * Remove active entities
     *
     * \@example
     *
     * store.removeActive(2)
     * store.removeActive([3, 4, 5])
     * @template T
     * @param {?} ids
     * @return {?}
     */
    EntityStore.prototype.removeActive = /**
     * Remove active entities
     *
     * \@example
     *
     * store.removeActive(2)
     * store.removeActive([3, 4, 5])
     * @template T
     * @param {?} ids
     * @return {?}
     */
    function (ids) {
        var _this = this;
        /** @type {?} */
        var toArray = coerceArray(ids);
        if (isEmpty(toArray))
            return;
        /** @type {?} */
        var someExist = toArray.some((/**
         * @param {?} id
         * @return {?}
         */
        function (id) { return _this.active.indexOf(id) > -1; }));
        if (!someExist)
            return;
        isDev() && setAction('Remove Active', ids);
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        function (state) {
            return tslib_1.__assign({}, state, { active: Array.isArray(state.active) ? state.active.filter((/**
                 * @param {?} currentId
                 * @return {?}
                 */
                function (currentId) { return toArray.indexOf(currentId) === -1; })) : null });
        }));
    };
    /**
     * Toggle active entities
     *
     * @example
     *
     * store.toggle(2)
     * store.toggle([3, 4, 5])
     */
    /**
     * Toggle active entities
     *
     * \@example
     *
     * store.toggle(2)
     * store.toggle([3, 4, 5])
     * @template T
     * @param {?} ids
     * @return {?}
     */
    EntityStore.prototype.toggleActive = /**
     * Toggle active entities
     *
     * \@example
     *
     * store.toggle(2)
     * store.toggle([3, 4, 5])
     * @template T
     * @param {?} ids
     * @return {?}
     */
    function (ids) {
        var _this = this;
        /** @type {?} */
        var toArray = coerceArray(ids);
        /** @type {?} */
        var filterExists = (/**
         * @param {?} remove
         * @return {?}
         */
        function (remove) { return (/**
         * @param {?} id
         * @return {?}
         */
        function (id) { return _this.active.includes(id) === remove; }); });
        /** @type {?} */
        var remove = toArray.filter(filterExists(true));
        /** @type {?} */
        var add = toArray.filter(filterExists(false));
        this.removeActive(remove);
        this.addActive(add);
        isDev() && logAction('Toggle Active');
    };
    /**
     *
     * Create sub UI store for managing Entity's UI state
     *
     * @example
     *
     * export type ProductUI = {
     *   isLoading: boolean;
     *   isOpen: boolean
     * }
     *
     * interface ProductsUIState extends EntityState<ProductUI> {}
     *
     * export class ProductsStore EntityStore<ProductsState, Product> {
     *   ui: EntityUIStore<ProductsUIState, ProductUI>;
     *
     *   constructor() {
     *     super();
     *     this.createUIStore();
     *   }
     *
     * }
     */
    /**
     *
     * Create sub UI store for managing Entity's UI state
     *
     * \@example
     *
     * export type ProductUI = {
     *   isLoading: boolean;
     *   isOpen: boolean
     * }
     *
     * interface ProductsUIState extends EntityState<ProductUI> {}
     *
     * export class ProductsStore EntityStore<ProductsState, Product> {
     *   ui: EntityUIStore<ProductsUIState, ProductUI>;
     *
     *   constructor() {
     *     super();
     *     this.createUIStore();
     *   }
     *
     * }
     * @param {?=} initialState
     * @param {?=} storeConfig
     * @return {?}
     */
    EntityStore.prototype.createUIStore = /**
     *
     * Create sub UI store for managing Entity's UI state
     *
     * \@example
     *
     * export type ProductUI = {
     *   isLoading: boolean;
     *   isOpen: boolean
     * }
     *
     * interface ProductsUIState extends EntityState<ProductUI> {}
     *
     * export class ProductsStore EntityStore<ProductsState, Product> {
     *   ui: EntityUIStore<ProductsUIState, ProductUI>;
     *
     *   constructor() {
     *     super();
     *     this.createUIStore();
     *   }
     *
     * }
     * @param {?=} initialState
     * @param {?=} storeConfig
     * @return {?}
     */
    function (initialState, storeConfig) {
        if (initialState === void 0) { initialState = {}; }
        if (storeConfig === void 0) { storeConfig = {}; }
        /** @type {?} */
        var defaults = { name: "UI/" + this.storeName, idKey: this.idKey };
        this.ui = new EntityUIStore(initialState, tslib_1.__assign({}, defaults, storeConfig));
        return this.ui;
    };
    // @internal
    // @internal
    /**
     * @return {?}
     */
    EntityStore.prototype.destroy = 
    // @internal
    /**
     * @return {?}
     */
    function () {
        _super.prototype.destroy.call(this);
        if (this.ui instanceof EntityStore) {
            this.ui.destroy();
        }
        this.entityActions.complete();
    };
    // @internal
    // @internal
    /**
     * @param {?} _
     * @param {?} nextEntity
     * @return {?}
     */
    EntityStore.prototype.akitaPreUpdateEntity = 
    // @internal
    /**
     * @param {?} _
     * @param {?} nextEntity
     * @return {?}
     */
    function (_, nextEntity) {
        return (/** @type {?} */ (nextEntity));
    };
    // @internal
    // @internal
    /**
     * @param {?} newEntity
     * @return {?}
     */
    EntityStore.prototype.akitaPreAddEntity = 
    // @internal
    /**
     * @param {?} newEntity
     * @return {?}
     */
    function (newEntity) {
        return (/** @type {?} */ (newEntity));
    };
    // @internal
    // @internal
    /**
     * @param {?} newEntity
     * @return {?}
     */
    EntityStore.prototype.akitaPreCheckEntity = 
    // @internal
    /**
     * @param {?} newEntity
     * @return {?}
     */
    function (newEntity) {
        return newEntity;
    };
    Object.defineProperty(EntityStore.prototype, "ids", {
        get: /**
         * @private
         * @return {?}
         */
        function () {
            return this._value().ids;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(EntityStore.prototype, "entities", {
        get: /**
         * @private
         * @return {?}
         */
        function () {
            return this._value().entities;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(EntityStore.prototype, "active", {
        get: /**
         * @private
         * @return {?}
         */
        function () {
            return this._value().active;
        },
        enumerable: true,
        configurable: true
    });
    /**
     * @private
     * @param {?} ids
     * @return {?}
     */
    EntityStore.prototype._setActive = /**
     * @private
     * @param {?} ids
     * @return {?}
     */
    function (ids) {
        this._setState((/**
         * @param {?} state
         * @return {?}
         */
        function (state) {
            return tslib_1.__assign({}, state, { active: ids });
        }));
    };
    /**
     * @private
     * @param {?=} add
     * @return {?}
     */
    EntityStore.prototype.handleUICreation = /**
     * @private
     * @param {?=} add
     * @return {?}
     */
    function (add) {
        var _this = this;
        if (add === void 0) { add = false; }
        /** @type {?} */
        var ids = this.ids;
        /** @type {?} */
        var isFunc = isFunction(this.ui._akitaCreateEntityFn);
        /** @type {?} */
        var uiEntities;
        /** @type {?} */
        var createFn = (/**
         * @param {?} id
         * @return {?}
         */
        function (id) {
            var _a;
            /** @type {?} */
            var current = _this.entities[id];
            /** @type {?} */
            var ui = isFunc ? _this.ui._akitaCreateEntityFn(current) : _this.ui._akitaCreateEntityFn;
            return tslib_1.__assign((_a = {}, _a[_this.idKey] = current[_this.idKey], _a), ui);
        });
        if (add) {
            uiEntities = this.ids.filter((/**
             * @param {?} id
             * @return {?}
             */
            function (id) { return isUndefined(_this.ui.entities[id]); })).map(createFn);
        }
        else {
            uiEntities = ids.map(createFn);
        }
        add ? this.ui.add(uiEntities) : this.ui.set(uiEntities);
    };
    /**
     * @private
     * @return {?}
     */
    EntityStore.prototype.hasInitialUIState = /**
     * @private
     * @return {?}
     */
    function () {
        return this.hasUIStore() && isUndefined(this.ui._akitaCreateEntityFn) === false;
    };
    /**
     * @private
     * @param {?} ids
     * @return {?}
     */
    EntityStore.prototype.handleUIRemove = /**
     * @private
     * @param {?} ids
     * @return {?}
     */
    function (ids) {
        if (this.hasUIStore()) {
            this.ui.remove(ids);
        }
    };
    /**
     * @private
     * @return {?}
     */
    EntityStore.prototype.hasUIStore = /**
     * @private
     * @return {?}
     */
    function () {
        return this.ui instanceof EntityUIStore;
    };
    var _a;
    tslib_1.__decorate([
        transaction(),
        tslib_1.__metadata("design:type", Function),
        tslib_1.__metadata("design:paramtypes", [Object, Object, Object]),
        tslib_1.__metadata("design:returntype", void 0)
    ], EntityStore.prototype, "upsert", null);
    tslib_1.__decorate([
        transaction(),
        tslib_1.__metadata("design:type", Function),
        tslib_1.__metadata("design:paramtypes", [typeof (_a = typeof T !== "undefined" && T) === "function" ? _a : Object]),
        tslib_1.__metadata("design:returntype", void 0)
    ], EntityStore.prototype, "toggleActive", null);
    return EntityStore;
}(Store));
export { EntityStore };
if (false) {
    /** @type {?} */
    EntityStore.prototype.ui;
    /**
     * @type {?}
     * @private
     */
    EntityStore.prototype.entityActions;
    /**
     * @type {?}
     * @protected
     */
    EntityStore.prototype.options;
}
// @internal
/**
 * @template UIState, DEPRECATED
 */
var 
// @internal
/**
 * @template UIState, DEPRECATED
 */
EntityUIStore = /** @class */ (function (_super) {
    tslib_1.__extends(EntityUIStore, _super);
    function EntityUIStore(initialState, storeConfig) {
        if (initialState === void 0) { initialState = {}; }
        if (storeConfig === void 0) { storeConfig = {}; }
        return _super.call(this, initialState, storeConfig) || this;
    }
    /**
     *
     * Set the initial UI entity state. This function will determine the entity's
     * initial state when we call `set()` or `add()`.
     *
     * @example
     *
     * constructor() {
     *   super();
     *   this.createUIStore().setInitialEntityState(entity => ({ isLoading: false, isOpen: true }));
     *   this.createUIStore().setInitialEntityState({ isLoading: false, isOpen: true });
     * }
     *
     */
    /**
     *
     * Set the initial UI entity state. This function will determine the entity's
     * initial state when we call `set()` or `add()`.
     *
     * \@example
     *
     * constructor() {
     *   super();
     *   this.createUIStore().setInitialEntityState(entity => ({ isLoading: false, isOpen: true }));
     *   this.createUIStore().setInitialEntityState({ isLoading: false, isOpen: true });
     * }
     *
     * @template EntityUI, Entity
     * @param {?} createFn
     * @return {?}
     */
    EntityUIStore.prototype.setInitialEntityState = /**
     *
     * Set the initial UI entity state. This function will determine the entity's
     * initial state when we call `set()` or `add()`.
     *
     * \@example
     *
     * constructor() {
     *   super();
     *   this.createUIStore().setInitialEntityState(entity => ({ isLoading: false, isOpen: true }));
     *   this.createUIStore().setInitialEntityState({ isLoading: false, isOpen: true });
     * }
     *
     * @template EntityUI, Entity
     * @param {?} createFn
     * @return {?}
     */
    function (createFn) {
        this._akitaCreateEntityFn = createFn;
    };
    return EntityUIStore;
}(EntityStore));
// @internal
/**
 * @template UIState, DEPRECATED
 */
export { EntityUIStore };
if (false) {
    /** @type {?} */
    EntityUIStore.prototype._akitaCreateEntityFn;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZW50aXR5U3RvcmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AZGF0b3JhbWEvYWtpdGEvIiwic291cmNlcyI6WyJzcmMvZW50aXR5U3RvcmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3BDLE9BQU8sRUFBZSxXQUFXLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDekQsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLFNBQVMsQ0FBQztBQUVoQyxPQUFPLEVBQUUsaUJBQWlCLEVBQW9CLE1BQU0scUJBQXFCLENBQUM7QUFDMUUsT0FBTyxFQUFFLFdBQVcsRUFBc0IsTUFBTSxlQUFlLENBQUM7QUFDaEUsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM1QyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDbEQsT0FBTyxFQUFFLHVCQUF1QixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDcEUsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUN4QyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDbEQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM1QyxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ2hDLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDMUMsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUU1QyxPQUFPLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUNqRCxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sT0FBTyxDQUFDO0FBQzlCLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDeEMsT0FBTyxFQUFjLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMz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QW5ZRDtRQURDLFdBQVcsRUFBRTs7Ozs2Q0FtQmI7SUEyUEQ7UUFEQyxXQUFXLEVBQUU7O3FFQUN5QixDQUFDLG9CQUFELENBQUM7O21EQVF2QztJQStHSCxrQkFBQztDQUFBLEFBemlCRCxDQUFvSCxLQUFLLEdBeWlCeEg7U0F6aUJZLFdBQVc7OztJQUN0Qix5QkFBbUM7Ozs7O0lBQ25DLG9DQUE0RDs7Ozs7SUFFakIsOEJBQW1EOzs7Ozs7QUF3aUJoRzs7Ozs7O0lBQThELHlDQUFvQjtJQUdoRix1QkFBWSxZQUFpQixFQUFFLFdBQTZDO1FBQWhFLDZCQUFBLEVBQUEsaUJBQWlCO1FBQUUsNEJBQUEsRUFBQSxnQkFBNkM7ZUFDMUUsa0JBQU0sWUFBWSxFQUFFLFdBQVcsQ0FBQztJQUNsQyxDQUFDO0lBRUQ7Ozs7Ozs7Ozs7Ozs7T0FhRzs7Ozs7Ozs7Ozs7Ozs7Ozs7O0lBQ0gsNkNBQXFCOzs7Ozs7Ozs7Ozs7Ozs7OztJQUFyQixVQUFvRCxRQUE0QztRQUM5RixJQUFJLENBQUMsb0JBQW9CLEdBQUcsUUFBUSxDQUFDO0lBQ3ZDLENBQUM7SUFDSCxvQkFBQztBQUFELENBQUMsQUF4QkQsQ0FBOEQsV0FBVyxHQXdCeEU7Ozs7Ozs7O0lBdkJDLDZDQUF1QyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGlzRW1wdHkgfSBmcm9tICcuL2lzRW1wdHknO1xuaW1wb3J0IHsgU2V0RW50aXRpZXMsIHNldEVudGl0aWVzIH0gZnJvbSAnLi9zZXRFbnRpdGllcyc7XG5pbXBvcnQgeyBTdG9yZSB9IGZyb20gJy4vc3RvcmUnO1xuaW1wb3J0IHsgQ29uc3RydWN0b3IsIEVudGl0eVN0YXRlLCBFbnRpdHlVSUNyZWF0ZUZuLCBJRCwgSURTLCBPckFycmF5LCBTdGF0ZVdpdGhBY3RpdmUsIFVwZGF0ZUVudGl0eVByZWRpY2F0ZSwgVXBkYXRlU3RhdGVDYWxsYmFjaywgZ2V0RW50aXR5VHlwZSwgZ2V0SURUeXBlIH0gZnJvbSAnLi90eXBlcyc7XG5pbXBvcnQgeyBnZXRBY3RpdmVFbnRpdGllcywgU2V0QWN0aXZlT3B0aW9ucyB9IGZyb20gJy4vZ2V0QWN0aXZlRW50aXRpZXMnO1xuaW1wb3J0IHsgYWRkRW50aXRpZXMsIEFkZEVudGl0aWVzT3B0aW9ucyB9IGZyb20gJy4vYWRkRW50aXRpZXMnO1xuaW1wb3J0IHsgY29lcmNlQXJyYXkgfSBmcm9tICcuL2NvZXJjZUFycmF5JztcbmltcG9ydCB7IHJlbW92ZUVudGl0aWVzIH0gZnJvbSAnLi9yZW1vdmVFbnRpdGllcyc7XG5pbXBvcnQgeyBnZXRJbml0aWFsRW50aXRpZXNTdGF0ZSB9IGZyb20gJy4vZ2V0SW5pdGlhbEVudGl0aWVzU3RhdGUnO1xuaW1wb3J0IHsgaXNEZWZpbmVkIH0gZnJvbSAnLi9pc0RlZmluZWQnO1xuaW1wb3J0IHsgdXBkYXRlRW50aXRpZXMgfSBmcm9tICcuL3VwZGF0ZUVudGl0aWVzJztcbmltcG9ydCB7IHRyYW5zYWN0aW9uIH0gZnJvbSAnLi90cmFuc2FjdGlvbic7XG5pbXBvcnQgeyBpc05pbCB9IGZyb20gJy4vaXNOaWwnO1xuaW1wb3J0IHsgaXNGdW5jdGlvbiB9IGZyb20gJy4vaXNGdW5jdGlvbic7XG5pbXBvcnQgeyBpc1VuZGVmaW5lZCB9IGZyb20gJy4vaXNVbmRlZmluZWQnO1xuaW1wb3J0IHsgU3RvcmVDb25maWdPcHRpb25zIH0gZnJvbSAnLi9zdG9yZUNvbmZpZyc7XG5pbXBvcnQgeyBsb2dBY3Rpb24sIHNldEFjdGlvbiB9IGZyb20gJy4vYWN0aW9ucyc7XG5pbXBvcnQgeyBpc0RldiB9IGZyb20gJy4vZW52JztcbmltcG9ydCB7IGhhc0VudGl0eSB9IGZyb20gJy4vaGFzRW50aXR5JztcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IEVudGl0eUFjdGlvbiwgRW50aXR5QWN0aW9ucyB9IGZyb20gJy4vZW50aXR5QWN0aW9ucyc7XG5pbXBvcnQgeyBERUZBVUxUX0lEX0tFWSB9IGZyb20gJy4vZGVmYXVsdElES2V5JztcblxuLyoqXG4gKlxuICogU3RvcmUgZm9yIG1hbmFnaW5nIGEgY29sbGVjdGlvbiBvZiBlbnRpdGllc1xuICpcbiAqIEBleGFtcGxlXG4gKlxuICogZXhwb3J0IGludGVyZmFjZSBXaWRnZXRzU3RhdGUgZXh0ZW5kcyBFbnRpdHlTdGF0ZTxXaWRnZXQ+IHsgfVxuICpcbiAqIEBTdG9yZUNvbmZpZyh7IG5hbWU6ICd3aWRnZXRzJyB9KVxuICogIGV4cG9ydCBjbGFzcyBXaWRnZXRzU3RvcmUgZXh0ZW5kcyBFbnRpdHlTdG9yZTxXaWRnZXRzU3RhdGU+IHtcbiAqICAgY29uc3RydWN0b3IoKSB7XG4gKiAgICAgc3VwZXIoKTtcbiAqICAgfVxuICogfVxuICpcbiAqXG4gKi9cbmV4cG9ydCBjbGFzcyBFbnRpdHlTdG9yZTxTIGV4dGVuZHMgRW50aXR5U3RhdGUgPSBhbnksIEVudGl0eVR5cGUgPSBnZXRFbnRpdHlUeXBlPFM+LCBJRFR5cGUgPSBnZXRJRFR5cGU8Uz4+IGV4dGVuZHMgU3RvcmU8Uz4ge1xuICB1aTogRW50aXR5VUlTdG9yZTxhbnksIEVudGl0eVR5cGU+O1xuICBwcml2YXRlIGVudGl0eUFjdGlvbnMgPSBuZXcgU3ViamVjdDxFbnRpdHlBY3Rpb248SURUeXBlPj4oKTtcblxuICBjb25zdHJ1Y3Rvcihpbml0aWFsU3RhdGU6IFBhcnRpYWw8Uz4gPSB7fSwgcHJvdGVjdGVkIG9wdGlvbnM6IFBhcnRpYWw8U3RvcmVDb25maWdPcHRpb25zPiA9IHt9KSB7XG4gICAgc3VwZXIoeyAuLi5nZXRJbml0aWFsRW50aXRpZXNTdGF0ZSgpLCAuLi5pbml0aWFsU3RhdGUgfSwgb3B0aW9ucyk7XG4gIH1cblxuICAvLyBAaW50ZXJuYWxcbiAgZ2V0IHNlbGVjdEVudGl0eUFjdGlvbiQoKTogT2JzZXJ2YWJsZTxFbnRpdHlBY3Rpb248SURUeXBlPj4ge1xuICAgIHJldHVybiB0aGlzLmVudGl0eUFjdGlvbnMuYXNPYnNlcnZhYmxlKCk7XG4gIH1cblxuICAvLyBAaW50ZXJuYWxcbiAgZ2V0IGlkS2V5KCkge1xuICAgIHJldHVybiAodGhpcy5jb25maWcgYXMgU3RvcmVDb25maWdPcHRpb25zKS5pZEtleSB8fCB0aGlzLm9wdGlvbnMuaWRLZXkgfHwgREVGQVVMVF9JRF9LRVk7XG4gIH1cblxuICAvKipcbiAgICpcbiAgICogUmVwbGFjZSBjdXJyZW50IGNvbGxlY3Rpb24gd2l0aCBwcm92aWRlZCBjb2xsZWN0aW9uXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqXG4gICAqIHRoaXMuc3RvcmUuc2V0KFtFbnRpdHksIEVudGl0eV0pXG4gICAqIHRoaXMuc3RvcmUuc2V0KHtpZHM6IFtdLCBlbnRpdGllczoge319KVxuICAgKiB0aGlzLnN0b3JlLnNldCh7IDE6IHt9LCAyOiB7fX0pXG4gICAqXG4gICAqL1xuICBzZXQoZW50aXRpZXM6IFNldEVudGl0aWVzPEVudGl0eVR5cGU+KSB7XG4gICAgaWYgKGlzTmlsKGVudGl0aWVzKSkgcmV0dXJuO1xuXG4gICAgaXNEZXYoKSAmJiBzZXRBY3Rpb24oJ1NldCBFbnRpdHknKTtcblxuICAgIGNvbnN0IGlzTmF0aXZlUHJlQWRkID0gdGhpcy5ha2l0YVByZUFkZEVudGl0eSA9PT0gRW50aXR5U3RvcmUucHJvdG90eXBlLmFraXRhUHJlQWRkRW50aXR5O1xuICAgIHRoaXMuX3NldFN0YXRlKHN0YXRlID0+XG4gICAgICBzZXRFbnRpdGllcyh7XG4gICAgICAgIHN0YXRlLFxuICAgICAgICBlbnRpdGllcyxcbiAgICAgICAgaWRLZXk6IHRoaXMuaWRLZXksXG4gICAgICAgIHByZUFkZEVudGl0eTogdGhpcy5ha2l0YVByZUFkZEVudGl0eSxcbiAgICAgICAgaXNOYXRpdmVQcmVBZGRcbiAgICAgIH0pXG4gICAgKTtcblxuICAgIHRoaXMuc2V0SGFzQ2FjaGUodHJ1ZSwgeyByZXN0YXJ0VFRMOiB0cnVlIH0pO1xuXG4gICAgaWYgKHRoaXMuaGFzSW5pdGlhbFVJU3RhdGUoKSkge1xuICAgICAgdGhpcy5oYW5kbGVVSUNyZWF0aW9uKCk7XG4gICAgfVxuXG4gICAgdGhpcy5lbnRpdHlBY3Rpb25zLm5leHQoeyB0eXBlOiBFbnRpdHlBY3Rpb25zLlNldCwgaWRzOiB0aGlzLmlkcyB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgZW50aXRpZXNcbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICpcbiAgICogdGhpcy5zdG9yZS5hZGQoW0VudGl0eSwgRW50aXR5XSlcbiAgICogdGhpcy5zdG9yZS5hZGQoRW50aXR5KVxuICAgKiB0aGlzLnN0b3JlLmFkZChFbnRpdHksIHsgcHJlcGVuZDogdHJ1ZSB9KVxuICAgKlxuICAgKiB0aGlzLnN0b3JlLmFkZChFbnRpdHksIHsgbG9hZGluZzogZmFsc2UgfSlcbiAgICovXG4gIGFkZChlbnRpdGllczogT3JBcnJheTxFbnRpdHlUeXBlPiwgb3B0aW9uczogQWRkRW50aXRpZXNPcHRpb25zID0geyBsb2FkaW5nOiBmYWxzZSB9KSB7XG4gICAgY29uc3QgY29sbGVjdGlvbiA9IGNvZXJjZUFycmF5KGVudGl0aWVzKTtcblxuICAgIGlmIChpc0VtcHR5KGNvbGxlY3Rpb24pKSByZXR1cm47XG5cbiAgICBjb25zdCBkYXRhID0gYWRkRW50aXRpZXMoe1xuICAgICAgc3RhdGU6IHRoaXMuX3ZhbHVlKCksXG4gICAgICBwcmVBZGRFbnRpdHk6IHRoaXMuYWtpdGFQcmVBZGRFbnRpdHksXG4gICAgICBlbnRpdGllczogY29sbGVjdGlvbixcbiAgICAgIGlkS2V5OiB0aGlzLmlkS2V5LFxuICAgICAgb3B0aW9uc1xuICAgIH0pO1xuXG4gICAgaWYgKGRhdGEpIHtcbiAgICAgIGlzRGV2KCkgJiYgc2V0QWN0aW9uKCdBZGQgRW50aXR5Jyk7XG4gICAgICBkYXRhLm5ld1N0YXRlLmxvYWRpbmcgPSBvcHRpb25zLmxvYWRpbmc7XG5cbiAgICAgIHRoaXMuX3NldFN0YXRlKCgpID0+IGRhdGEubmV3U3RhdGUpO1xuXG4gICAgICBpZiAodGhpcy5oYXNJbml0aWFsVUlTdGF0ZSgpKSB7XG4gICAgICAgIHRoaXMuaGFuZGxlVUlDcmVhdGlvbih0cnVlKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5lbnRpdHlBY3Rpb25zLm5leHQoeyB0eXBlOiBFbnRpdHlBY3Rpb25zLkFkZCwgaWRzOiBkYXRhLm5ld0lkcyB9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICpcbiAgICogVXBkYXRlIGVudGl0aWVzXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqXG4gICAqIHN0b3JlLnVwZGF0ZSgxLCBlbnRpdHkgPT4gLi4uKVxuICAgKiBzdG9yZS51cGRhdGUoWzEsIDIsIDNdLCBlbnRpdHkgPT4gLi4uKVxuICAgKiBzdG9yZS51cGRhdGUobnVsbCwgZW50aXR5ID0+IC4uLilcbiAgICovXG4gIHVwZGF0ZShpZDogT3JBcnJheTxJRFR5cGU+IHwgbnVsbCwgbmV3U3RhdGVGbjogVXBkYXRlU3RhdGVDYWxsYmFjazxFbnRpdHlUeXBlPik7XG4gIC8qKlxuICAgKiBzdG9yZS51cGRhdGUoMSwgeyBuYW1lOiBuZXdOYW1lIH0pXG4gICAqL1xuICB1cGRhdGUoaWQ6IE9yQXJyYXk8SURUeXBlPiB8IG51bGwsIG5ld1N0YXRlOiBQYXJ0aWFsPEVudGl0eVR5cGU+KTtcbiAgLyoqXG4gICAqIHN0b3JlLnVwZGF0ZShlbnRpdHkgPT4gZW50aXR5LnByaWNlID4gMywgZW50aXR5ID0+ICh7IG5hbWU6IG5ld05hbWUgfSkpXG4gICAqL1xuICB1cGRhdGUocHJlZGljYXRlOiBVcGRhdGVFbnRpdHlQcmVkaWNhdGU8RW50aXR5VHlwZT4sIG5ld1N0YXRlRm46IFVwZGF0ZVN0YXRlQ2FsbGJhY2s8RW50aXR5VHlwZT4pO1xuICAvKipcbiAgICogc3RvcmUudXBkYXRlKGVudGl0eSA9PiBlbnRpdHkucHJpY2UgPiAzLCB7IG5hbWU6IG5ld05hbWUgfSlcbiAgICovXG4gIHVwZGF0ZShwcmVkaWNhdGU6IFVwZGF0ZUVudGl0eVByZWRpY2F0ZTxFbnRpdHlUeXBlPiwgbmV3U3RhdGU6IFBhcnRpYWw8RW50aXR5VHlwZT4pO1xuICAvKiogU3VwcG9ydCBub24tZW50aXR5IHVwZGF0ZXMgKi9cbiAgdXBkYXRlKG5ld1N0YXRlOiBVcGRhdGVTdGF0ZUNhbGxiYWNrPFM+KTtcbiAgdXBkYXRlKG5ld1N0YXRlOiBQYXJ0aWFsPFM+KTtcbiAgdXBkYXRlKFxuICAgIGlkc09yRm5PclN0YXRlOiBPckFycmF5PElEVHlwZT4gfCBudWxsIHwgUGFydGlhbDxTPiB8IFVwZGF0ZVN0YXRlQ2FsbGJhY2s8Uz4gfCBVcGRhdGVFbnRpdHlQcmVkaWNhdGU8RW50aXR5VHlwZT4sXG4gICAgbmV3U3RhdGVPckZuPzogVXBkYXRlU3RhdGVDYWxsYmFjazxFbnRpdHlUeXBlPiB8IFBhcnRpYWw8RW50aXR5VHlwZT4gfCBQYXJ0aWFsPFM+XG4gICkge1xuICAgIGlmIChpc1VuZGVmaW5lZChuZXdTdGF0ZU9yRm4pKSB7XG4gICAgICBzdXBlci51cGRhdGUoaWRzT3JGbk9yU3RhdGUgYXMgUGFydGlhbDxTPik7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGxldCBpZHM6IElEVHlwZVtdID0gW107XG5cbiAgICBpZiAoaXNGdW5jdGlvbihpZHNPckZuT3JTdGF0ZSkpIHtcbiAgICAgIC8vIFdlIG5lZWQgdG8gZmlsdGVyIGFjY29yZGluZyB0aGUgcHJlZGljYXRlIGZ1bmN0aW9uXG4gICAgICBpZHMgPSB0aGlzLmlkcy5maWx0ZXIoaWQgPT4gKGlkc09yRm5PclN0YXRlIGFzIFVwZGF0ZUVudGl0eVByZWRpY2F0ZTxFbnRpdHlUeXBlPikodGhpcy5lbnRpdGllc1tpZF0pKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gSWYgaXQncyBuaWwgd2Ugd2FudCBhbGwgb2YgdGhlbVxuICAgICAgaWRzID0gaXNOaWwoaWRzT3JGbk9yU3RhdGUpID8gdGhpcy5pZHMgOiBjb2VyY2VBcnJheShpZHNPckZuT3JTdGF0ZSBhcyBPckFycmF5PElEVHlwZT4pO1xuICAgIH1cblxuICAgIGlmIChpc0VtcHR5KGlkcykpIHJldHVybjtcblxuICAgIGlzRGV2KCkgJiYgc2V0QWN0aW9uKCdVcGRhdGUgRW50aXR5JywgaWRzKTtcbiAgICB0aGlzLl9zZXRTdGF0ZShzdGF0ZSA9PlxuICAgICAgdXBkYXRlRW50aXRpZXMoe1xuICAgICAgICBpZEtleTogdGhpcy5pZEtleSxcbiAgICAgICAgaWRzLFxuICAgICAgICBwcmVVcGRhdGVFbnRpdHk6IHRoaXMuYWtpdGFQcmVVcGRhdGVFbnRpdHksXG4gICAgICAgIHN0YXRlLFxuICAgICAgICBuZXdTdGF0ZU9yRm4sXG4gICAgICAgIHByb2R1Y2VyRm46IHRoaXMuX3Byb2R1Y2VyRm5cbiAgICAgIH0pXG4gICAgKTtcblxuICAgIHRoaXMuZW50aXR5QWN0aW9ucy5uZXh0KHsgdHlwZTogRW50aXR5QWN0aW9ucy5VcGRhdGUsIGlkcyB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKlxuICAgKiBDcmVhdGUgb3IgdXBkYXRlXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqXG4gICAqIHN0b3JlLnVwc2VydCgxLCB7IGFjdGl2ZTogdHJ1ZSB9KVxuICAgKiBzdG9yZS51cHNlcnQoWzIsIDNdLCB7IGFjdGl2ZTogdHJ1ZSB9KVxuICAgKiBzdG9yZS51cHNlcnQoWzIsIDNdLCBlbnRpdHkgPT4gKHsgaXNPcGVuOiAhZW50aXR5LmlzT3Blbn0pKVxuICAgKlxuICAgKi9cbiAgQHRyYW5zYWN0aW9uKClcbiAgdXBzZXJ0KGlkczogT3JBcnJheTxJRFR5cGU+LCBuZXdTdGF0ZTogUGFydGlhbDxFbnRpdHlUeXBlPiB8IEVudGl0eVR5cGUgfCBVcGRhdGVTdGF0ZUNhbGxiYWNrPEVudGl0eVR5cGU+IHwgRW50aXR5VHlwZVtdLCBvcHRpb25zOiB7IGJhc2VDbGFzcz86IENvbnN0cnVjdG9yIH0gPSB7fSkge1xuICAgIGNvbnN0IHRvQXJyYXkgPSBjb2VyY2VBcnJheShpZHMpO1xuICAgIGNvbnN0IHByZWRpY2F0ZSA9IGlzVXBkYXRlID0+IGlkID0+IGhhc0VudGl0eSh0aGlzLmVudGl0aWVzLCBpZCkgPT09IGlzVXBkYXRlO1xuICAgIGNvbnN0IGlzQ2xhc3NCYXNlZCA9IGlzRnVuY3Rpb24ob3B0aW9ucy5iYXNlQ2xhc3MpO1xuICAgIGNvbnN0IHVwZGF0ZUlkcyA9IHRvQXJyYXkuZmlsdGVyKHByZWRpY2F0ZSh0cnVlKSk7XG4gICAgY29uc3QgbmV3RW50aXRpZXMgPSB0b0FycmF5LmZpbHRlcihwcmVkaWNhdGUoZmFsc2UpKS5tYXAoaWQgPT4ge1xuICAgICAgbGV0IGVudGl0eSA9IGlzRnVuY3Rpb24obmV3U3RhdGUpID8gbmV3U3RhdGUoe30gYXMgRW50aXR5VHlwZSkgOiBuZXdTdGF0ZTtcbiAgICAgIGNvbnN0IHdpdGhJZCA9IHsgLi4uKGVudGl0eSBhcyBFbnRpdHlUeXBlKSwgW3RoaXMuaWRLZXldOiBpZCB9O1xuICAgICAgaWYgKGlzQ2xhc3NCYXNlZCkge1xuICAgICAgICByZXR1cm4gbmV3IG9wdGlvbnMuYmFzZUNsYXNzKHdpdGhJZCk7XG4gICAgICB9XG4gICAgICByZXR1cm4gd2l0aElkO1xuICAgIH0pO1xuXG4gICAgLy8gaXQgY2FuIGJlIGFueSBvZiB0aGUgdGhyZWUgdHlwZXNcbiAgICB0aGlzLnVwZGF0ZSh1cGRhdGVJZHMgYXMgYW55LCBuZXdTdGF0ZSBhcyBhbnkpO1xuICAgIHRoaXMuYWRkKG5ld0VudGl0aWVzKTtcbiAgICBpc0RldigpICYmIGxvZ0FjdGlvbignVXBzZXJ0IEVudGl0eScpO1xuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIFVwc2VydCBlbnRpdHkgY29sbGVjdGlvbiAoaWRLZXkgbXVzdCBiZSBwcmVzZW50KVxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKlxuICAgKiBzdG9yZS51cHNlcnRNYW55KFsgeyBpZDogMSB9LCB7IGlkOiAyIH1dKTtcbiAgICpcbiAgICogc3RvcmUudXBzZXJ0TWFueShbIHsgaWQ6IDEgfSwgeyBpZDogMiB9XSwgeyBsb2FkaW5nOiB0cnVlICB9KTtcbiAgICogc3RvcmUudXBzZXJ0TWFueShbIHsgaWQ6IDEgfSwgeyBpZDogMiB9XSwgeyBiYXNlQ2xhc3M6IFRvZG8gIH0pO1xuICAgKlxuICAgKi9cbiAgdXBzZXJ0TWFueShlbnRpdGllczogRW50aXR5VHlwZVtdLCBvcHRpb25zOiB7IGJhc2VDbGFzcz86IENvbnN0cnVjdG9yOyBsb2FkaW5nPzogYm9vbGVhbiB9ID0ge30pIHtcbiAgICBjb25zdCBhZGRlZElkcyA9IFtdO1xuICAgIGNvbnN0IHVwZGF0ZWRJZHMgPSBbXTtcbiAgICBjb25zdCB1cGRhdGVkRW50aXRpZXMgPSB7fTtcblxuICAgIC8vIFVwZGF0ZSB0aGUgc3RhdGUgZGlyZWN0bHkgdG8gb3B0aW1pemUgcGVyZm9ybWFuY2VcbiAgICBmb3IgKGNvbnN0IGVudGl0eSBvZiBlbnRpdGllcykge1xuICAgICAgY29uc3Qgd2l0aFByZUNoZWNrSG9vayA9IHRoaXMuYWtpdGFQcmVDaGVja0VudGl0eShlbnRpdHkpO1xuICAgICAgY29uc3QgaWQgPSB3aXRoUHJlQ2hlY2tIb29rW3RoaXMuaWRLZXldO1xuICAgICAgaWYgKGhhc0VudGl0eSh0aGlzLmVudGl0aWVzLCBpZCkpIHtcbiAgICAgICAgY29uc3QgcHJldiA9IHRoaXMuX3ZhbHVlKCkuZW50aXRpZXNbaWRdO1xuICAgICAgICBjb25zdCBtZXJnZWQgPSB7IC4uLnRoaXMuX3ZhbHVlKCkuZW50aXRpZXNbaWRdLCAuLi53aXRoUHJlQ2hlY2tIb29rIH07XG4gICAgICAgIGNvbnN0IG5leHQgPSBvcHRpb25zLmJhc2VDbGFzcyA/IG5ldyBvcHRpb25zLmJhc2VDbGFzcyhtZXJnZWQpIDogbWVyZ2VkO1xuICAgICAgICBjb25zdCB3aXRoSG9vayA9IHRoaXMuYWtpdGFQcmVVcGRhdGVFbnRpdHkocHJldiwgbmV4dCk7XG4gICAgICAgIGNvbnN0IG5leHRJZCA9IHdpdGhIb29rW3RoaXMuaWRLZXldO1xuICAgICAgICB1cGRhdGVkRW50aXRpZXNbbmV4dElkXSA9IHdpdGhIb29rO1xuICAgICAgICB1cGRhdGVkSWRzLnB1c2gobmV4dElkKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IG5ld0VudGl0eSA9IG9wdGlvbnMuYmFzZUNsYXNzID8gbmV3IG9wdGlvbnMuYmFzZUNsYXNzKHdpdGhQcmVDaGVja0hvb2spIDogd2l0aFByZUNoZWNrSG9vaztcbiAgICAgICAgY29uc3Qgd2l0aEhvb2sgPSB0aGlzLmFraXRhUHJlQWRkRW50aXR5KG5ld0VudGl0eSk7XG4gICAgICAgIGNvbnN0IG5leHRJZCA9IHdpdGhIb29rW3RoaXMuaWRLZXldO1xuICAgICAgICBhZGRlZElkcy5wdXNoKG5leHRJZCk7XG4gICAgICAgIHVwZGF0ZWRFbnRpdGllc1tuZXh0SWRdID0gd2l0aEhvb2s7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaXNEZXYoKSAmJiBsb2dBY3Rpb24oJ1Vwc2VydCBNYW55Jyk7XG5cbiAgICB0aGlzLl9zZXRTdGF0ZShzdGF0ZSA9PiAoe1xuICAgICAgLi4uc3RhdGUsXG4gICAgICBpZHM6IGFkZGVkSWRzLmxlbmd0aCA/IFsuLi5zdGF0ZS5pZHMsIC4uLmFkZGVkSWRzXSA6IHN0YXRlLmlkcyxcbiAgICAgIGVudGl0aWVzOiB7XG4gICAgICAgIC4uLnN0YXRlLmVudGl0aWVzLFxuICAgICAgICAuLi51cGRhdGVkRW50aXRpZXNcbiAgICAgIH0sXG4gICAgICBsb2FkaW5nOiAhIW9wdGlvbnMubG9hZGluZ1xuICAgIH0pKTtcblxuICAgIHVwZGF0ZWRJZHMubGVuZ3RoICYmIHRoaXMuZW50aXR5QWN0aW9ucy5uZXh0KHsgdHlwZTogRW50aXR5QWN0aW9ucy5VcGRhdGUsIGlkczogdXBkYXRlZElkcyB9KTtcbiAgICBhZGRlZElkcy5sZW5ndGggJiYgdGhpcy5lbnRpdHlBY3Rpb25zLm5leHQoeyB0eXBlOiBFbnRpdHlBY3Rpb25zLkFkZCwgaWRzOiBhZGRlZElkcyB9KTtcbiAgICBpZiAoYWRkZWRJZHMubGVuZ3RoICYmIHRoaXMuaGFzVUlTdG9yZSgpKSB7XG4gICAgICB0aGlzLmhhbmRsZVVJQ3JlYXRpb24odHJ1ZSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIFJlcGxhY2Ugb25lIG9yIG1vcmUgZW50aXRpZXMgKGV4Y2VwdCB0aGUgaWQgcHJvcGVydHkpXG4gICAqXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqXG4gICAqIHRoaXMuc3RvcmUucmVwbGFjZSg1LCBuZXdFbnRpdHkpXG4gICAqIHRoaXMuc3RvcmUucmVwbGFjZShbMSwyLDNdLCBuZXdFbnRpdHkpXG4gICAqL1xuICByZXBsYWNlKGlkczogSURTLCBuZXdTdGF0ZTogUGFydGlhbDxFbnRpdHlUeXBlPikge1xuICAgIGNvbnN0IHRvQXJyYXkgPSBjb2VyY2VBcnJheShpZHMpO1xuICAgIGlmIChpc0VtcHR5KHRvQXJyYXkpKSByZXR1cm47XG4gICAgbGV0IHJlcGxhY2VkID0ge307XG4gICAgZm9yIChjb25zdCBpZCBvZiB0b0FycmF5KSB7XG4gICAgICBuZXdTdGF0ZVt0aGlzLmlkS2V5XSA9IGlkO1xuICAgICAgcmVwbGFjZWRbaWRdID0gbmV3U3RhdGU7XG4gICAgfVxuICAgIGlzRGV2KCkgJiYgc2V0QWN0aW9uKCdSZXBsYWNlIEVudGl0eScsIGlkcyk7XG4gICAgdGhpcy5fc2V0U3RhdGUoc3RhdGUgPT4gKHtcbiAgICAgIC4uLnN0YXRlLFxuICAgICAgZW50aXRpZXM6IHtcbiAgICAgICAgLi4uc3RhdGUuZW50aXRpZXMsXG4gICAgICAgIC4uLnJlcGxhY2VkXG4gICAgICB9XG4gICAgfSkpO1xuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIE1vdmUgZW50aXR5IGluc2lkZSB0aGUgY29sbGVjdGlvblxuICAgKlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKlxuICAgKiB0aGlzLnN0b3JlLm1vdmUoZnJvbUluZGV4LCB0b0luZGV4KVxuICAgKi9cbiAgbW92ZShmcm9tOiBudW1iZXIsIHRvOiBudW1iZXIpIHtcbiAgICBjb25zdCBpZHMgPSB0aGlzLmlkcy5zbGljZSgpO1xuICAgIGlkcy5zcGxpY2UodG8gPCAwID8gaWRzLmxlbmd0aCArIHRvIDogdG8sIDAsIGlkcy5zcGxpY2UoZnJvbSwgMSlbMF0pO1xuXG4gICAgaXNEZXYoKSAmJiBzZXRBY3Rpb24oJ01vdmUgRW50aXR5Jyk7XG4gICAgdGhpcy5fc2V0U3RhdGUoc3RhdGUgPT4gKHtcbiAgICAgIC4uLnN0YXRlLFxuICAgICAgLy8gQ2hhbmdlIHRoZSBlbnRpdGllcyByZWZlcmVuY2Ugc28gdGhhdCBzZWxlY3RBbGwgZW1pdFxuICAgICAgZW50aXRpZXM6IHtcbiAgICAgICAgLi4uc3RhdGUuZW50aXRpZXNcbiAgICAgIH0sXG4gICAgICBpZHNcbiAgICB9KSk7XG4gIH1cblxuICAvKipcbiAgICpcbiAgICogUmVtb3ZlIG9uZSBvciBtb3JlIGVudGl0aWVzXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqXG4gICAqIHRoaXMuc3RvcmUucmVtb3ZlKDUpXG4gICAqIHRoaXMuc3RvcmUucmVtb3ZlKFsxLDIsM10pXG4gICAqIHRoaXMuc3RvcmUucmVtb3ZlKClcbiAgICovXG4gIHJlbW92ZShpZD86IE9yQXJyYXk8SURUeXBlPik7XG4gIC8qKlxuICAgKiB0aGlzLnN0b3JlLnJlbW92ZShlbnRpdHkgPT4gZW50aXR5LmlkID09PSAxKVxuICAgKi9cbiAgcmVtb3ZlKHByZWRpY2F0ZTogKGVudGl0eTogUmVhZG9ubHk8RW50aXR5VHlwZT4pID0+IGJvb2xlYW4pO1xuICByZW1vdmUoaWRzT3JGbj86IE9yQXJyYXk8SURUeXBlPiB8ICgoZW50aXR5OiBSZWFkb25seTxFbnRpdHlUeXBlPikgPT4gYm9vbGVhbikpIHtcbiAgICBpZiAoaXNFbXB0eSh0aGlzLmlkcykpIHJldHVybjtcblxuICAgIGNvbnN0IGlkUGFzc2VkID0gaXNEZWZpbmVkKGlkc09yRm4pO1xuXG4gICAgLy8gbnVsbCBtZWFucyByZW1vdmUgYWxsXG4gICAgbGV0IGlkczogSURUeXBlW10gfCBudWxsID0gW107XG5cbiAgICBpZiAoaXNGdW5jdGlvbihpZHNPckZuKSkge1xuICAgICAgaWRzID0gdGhpcy5pZHMuZmlsdGVyKGVudGl0eUlkID0+IGlkc09yRm4odGhpcy5lbnRpdGllc1tlbnRpdHlJZF0pKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWRzID0gaWRQYXNzZWQgPyBjb2VyY2VBcnJheShpZHNPckZuKSA6IG51bGw7XG4gICAgfVxuXG4gICAgaWYgKGlzRW1wdHkoaWRzKSkgcmV0dXJuO1xuXG4gICAgaXNEZXYoKSAmJiBzZXRBY3Rpb24oJ1JlbW92ZSBFbnRpdHknLCBpZHMpO1xuICAgIHRoaXMuX3NldFN0YXRlKChzdGF0ZTogU3RhdGVXaXRoQWN0aXZlPFM+KSA9PiByZW1vdmVFbnRpdGllcyh7IHN0YXRlLCBpZHMgfSkpO1xuICAgIGlmIChpZHMgPT09IG51bGwpIHtcbiAgICAgIHRoaXMuc2V0SGFzQ2FjaGUoZmFsc2UpO1xuICAgIH1cblxuICAgIHRoaXMuaGFuZGxlVUlSZW1vdmUoaWRzKTtcbiAgICB0aGlzLmVudGl0eUFjdGlvbnMubmV4dCh7IHR5cGU6IEVudGl0eUFjdGlvbnMuUmVtb3ZlLCBpZHMgfSk7XG4gIH1cblxuICAvKipcbiAgICpcbiAgICogVXBkYXRlIHRoZSBhY3RpdmUgZW50aXR5XG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqXG4gICAqIHRoaXMuc3RvcmUudXBkYXRlQWN0aXZlKHsgY29tcGxldGVkOiB0cnVlIH0pXG4gICAqIHRoaXMuc3RvcmUudXBkYXRlQWN0aXZlKGFjdGl2ZSA9PiB7XG4gICAqICAgcmV0dXJuIHtcbiAgICogICAgIGNvbmZpZzoge1xuICAgKiAgICAgIC4uYWN0aXZlLmNvbmZpZyxcbiAgICogICAgICBkYXRlXG4gICAqICAgICB9XG4gICAqICAgfVxuICAgKiB9KVxuICAgKi9cbiAgdXBkYXRlQWN0aXZlKG5ld1N0YXRlT3JDYWxsYmFjazogVXBkYXRlU3RhdGVDYWxsYmFjazxFbnRpdHlUeXBlPiB8IFBhcnRpYWw8RW50aXR5VHlwZT4pIHtcbiAgICBjb25zdCBpZHMgPSBjb2VyY2VBcnJheSh0aGlzLmFjdGl2ZSk7XG4gICAgaXNEZXYoKSAmJiBzZXRBY3Rpb24oJ1VwZGF0ZSBBY3RpdmUnLCBpZHMpO1xuICAgIHRoaXMudXBkYXRlKGlkcywgbmV3U3RhdGVPckNhbGxiYWNrIGFzIFBhcnRpYWw8RW50aXR5VHlwZT4pO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCB0aGUgZ2l2ZW4gZW50aXR5IGFzIGFjdGl2ZVxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKlxuICAgKiBzdG9yZS5zZXRBY3RpdmUoMSlcbiAgICogc3RvcmUuc2V0QWN0aXZlKFsxLCAyLCAzXSlcbiAgICovXG4gIHNldEFjdGl2ZShpZE9yT3B0aW9uczogU1snYWN0aXZlJ10gZXh0ZW5kcyBhbnlbXSA/IFNbJ2FjdGl2ZSddIDogKFNldEFjdGl2ZU9wdGlvbnMgfCBTWydhY3RpdmUnXSkpO1xuICBzZXRBY3RpdmUoaWRPck9wdGlvbnM6IElEVHlwZSB8IFNldEFjdGl2ZU9wdGlvbnMgfCBudWxsKSB7XG4gICAgY29uc3QgYWN0aXZlID0gZ2V0QWN0aXZlRW50aXRpZXMoaWRPck9wdGlvbnMsIHRoaXMuaWRzLCB0aGlzLmFjdGl2ZSk7XG5cbiAgICBpZiAoYWN0aXZlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpc0RldigpICYmIHNldEFjdGlvbignU2V0IEFjdGl2ZScsIGFjdGl2ZSk7XG4gICAgdGhpcy5fc2V0QWN0aXZlKGFjdGl2ZSk7XG4gIH1cblxuICAvKipcbiAgICogQWRkIGFjdGl2ZSBlbnRpdGllc1xuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKlxuICAgKiBzdG9yZS5hZGRBY3RpdmUoMik7XG4gICAqIHN0b3JlLmFkZEFjdGl2ZShbMywgNCwgNV0pO1xuICAgKi9cbiAgYWRkQWN0aXZlPFQgPSBPckFycmF5PElEVHlwZT4+KGlkczogVCkge1xuICAgIGNvbnN0IHRvQXJyYXkgPSBjb2VyY2VBcnJheShpZHMpO1xuICAgIGlmIChpc0VtcHR5KHRvQXJyYXkpKSByZXR1cm47XG4gICAgY29uc3QgZXZlcnlFeGlzdCA9IHRvQXJyYXkuZXZlcnkoaWQgPT4gdGhpcy5hY3RpdmUuaW5kZXhPZihpZCkgPiAtMSk7XG4gICAgaWYgKGV2ZXJ5RXhpc3QpIHJldHVybjtcblxuICAgIGlzRGV2KCkgJiYgc2V0QWN0aW9uKCdBZGQgQWN0aXZlJywgaWRzKTtcbiAgICB0aGlzLl9zZXRTdGF0ZShzdGF0ZSA9PiB7XG4gICAgICAvKiogUHJvdGVjdCBhZ2FpbnN0IGNhc2UgdGhhdCBvbmUgb2YgdGhlIGl0ZW1zIGluIHRoZSBhcnJheSBleGlzdCAqL1xuICAgICAgY29uc3QgdW5pcXVlcyA9IEFycmF5LmZyb20obmV3IFNldChbLi4uKHN0YXRlLmFjdGl2ZSBhcyBJRFR5cGVbXSksIC4uLnRvQXJyYXldKSk7XG4gICAgICByZXR1cm4ge1xuICAgICAgICAuLi5zdGF0ZSxcbiAgICAgICAgYWN0aXZlOiB1bmlxdWVzXG4gICAgICB9O1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlbW92ZSBhY3RpdmUgZW50aXRpZXNcbiAgICpcbiAgICogQGV4YW1wbGVcbiAgICpcbiAgICogc3RvcmUucmVtb3ZlQWN0aXZlKDIpXG4gICAqIHN0b3JlLnJlbW92ZUFjdGl2ZShbMywgNCwgNV0pXG4gICAqL1xuICByZW1vdmVBY3RpdmU8VCA9IE9yQXJyYXk8SURUeXBlPj4oaWRzOiBUKSB7XG4gICAgY29uc3QgdG9BcnJheSA9IGNvZXJjZUFycmF5KGlkcyk7XG4gICAgaWYgKGlzRW1wdHkodG9BcnJheSkpIHJldHVybjtcbiAgICBjb25zdCBzb21lRXhpc3QgPSB0b0FycmF5LnNvbWUoaWQgPT4gdGhpcy5hY3RpdmUuaW5kZXhPZihpZCkgPiAtMSk7XG4gICAgaWYgKCFzb21lRXhpc3QpIHJldHVybjtcblxuICAgIGlzRGV2KCkgJiYgc2V0QWN0aW9uKCdSZW1vdmUgQWN0aXZlJywgaWRzKTtcbiAgICB0aGlzLl9zZXRTdGF0ZShzdGF0ZSA9PiB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICAuLi5zdGF0ZSxcbiAgICAgICAgYWN0aXZlOiBBcnJheS5pc0FycmF5KHN0YXRlLmFjdGl2ZSkgPyBzdGF0ZS5hY3RpdmUuZmlsdGVyKGN1cnJlbnRJZCA9PiB0b0FycmF5LmluZGV4T2YoY3VycmVudElkKSA9PT0gLTEpIDogbnVsbFxuICAgICAgfTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUb2dnbGUgYWN0aXZlIGVudGl0aWVzXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqXG4gICAqIHN0b3JlLnRvZ2dsZSgyKVxuICAgKiBzdG9yZS50b2dnbGUoWzMsIDQsIDVdKVxuICAgKi9cbiAgQHRyYW5zYWN0aW9uKClcbiAgdG9nZ2xlQWN0aXZlPFQgPSBPckFycmF5PElEVHlwZT4+KGlkczogVCkge1xuICAgIGNvbnN0IHRvQXJyYXkgPSBjb2VyY2VBcnJheShpZHMpO1xuICAgIGNvbnN0IGZpbHRlckV4aXN0cyA9IHJlbW92ZSA9PiBpZCA9PiB0aGlzLmFjdGl2ZS5pbmNsdWRlcyhpZCkgPT09IHJlbW92ZTtcbiAgICBjb25zdCByZW1vdmUgPSB0b0FycmF5LmZpbHRlcihmaWx0ZXJFeGlzdHModHJ1ZSkpO1xuICAgIGNvbnN0IGFkZCA9IHRvQXJyYXkuZmlsdGVyKGZpbHRlckV4aXN0cyhmYWxzZSkpO1xuICAgIHRoaXMucmVtb3ZlQWN0aXZlKHJlbW92ZSk7XG4gICAgdGhpcy5hZGRBY3RpdmUoYWRkKTtcbiAgICBpc0RldigpICYmIGxvZ0FjdGlvbignVG9nZ2xlIEFjdGl2ZScpO1xuICB9XG5cbiAgLyoqXG4gICAqXG4gICAqIENyZWF0ZSBzdWIgVUkgc3RvcmUgZm9yIG1hbmFnaW5nIEVudGl0eSdzIFVJIHN0YXRlXG4gICAqXG4gICAqIEBleGFtcGxlXG4gICAqXG4gICAqIGV4cG9ydCB0eXBlIFByb2R1Y3RVSSA9IHtcbiAgICogICBpc0xvYWRpbmc6IGJvb2xlYW47XG4gICAqICAgaXNPcGVuOiBib29sZWFuXG4gICAqIH1cbiAgICpcbiAgICogaW50ZXJmYWNlIFByb2R1Y3RzVUlTdGF0ZSBleHRlbmRzIEVudGl0eVN0YXRlPFByb2R1Y3RVST4ge31cbiAgICpcbiAgICogZXhwb3J0IGNsYXNzIFByb2R1Y3RzU3RvcmUgRW50aXR5U3RvcmU8UHJvZHVjdHNTdGF0ZSwgUHJvZHVjdD4ge1xuICAgKiAgIHVpOiBFbnRpdHlVSVN0b3JlPFByb2R1Y3RzVUlTdGF0ZSwgUHJvZHVjdFVJPjtcbiAgICpcbiAgICogICBjb25zdHJ1Y3RvcigpIHtcbiAgICogICAgIHN1cGVyKCk7XG4gICAqICAgICB0aGlzLmNyZWF0ZVVJU3RvcmUoKTtcbiAgICogICB9XG4gICAqXG4gICAqIH1cbiAgICovXG4gIGNyZWF0ZVVJU3RvcmUoaW5pdGlhbFN0YXRlID0ge30sIHN0b3JlQ29uZmlnOiBQYXJ0aWFsPFN0b3JlQ29uZmlnT3B0aW9ucz4gPSB7fSkge1xuICAgIGNvbnN0IGRlZmF1bHRzOiBQYXJ0aWFsPFN0b3JlQ29uZmlnT3B0aW9ucz4gPSB7IG5hbWU6IGBVSS8ke3RoaXMuc3RvcmVOYW1lfWAsIGlkS2V5OiB0aGlzLmlkS2V5IH07XG4gICAgdGhpcy51aSA9IG5ldyBFbnRpdHlVSVN0b3JlKGluaXRpYWxTdGF0ZSwgeyAuLi5kZWZhdWx0cywgLi4uc3RvcmVDb25maWcgfSk7XG4gICAgcmV0dXJuIHRoaXMudWk7XG4gIH1cblxuICAvLyBAaW50ZXJuYWxcbiAgZGVzdHJveSgpIHtcbiAgICBzdXBlci5kZXN0cm95KCk7XG4gICAgaWYgKHRoaXMudWkgaW5zdGFuY2VvZiBFbnRpdHlTdG9yZSkge1xuICAgICAgdGhpcy51aS5kZXN0cm95KCk7XG4gICAgfVxuICAgIHRoaXMuZW50aXR5QWN0aW9ucy5jb21wbGV0ZSgpO1xuICB9XG5cbiAgLy8gQGludGVybmFsXG4gIGFraXRhUHJlVXBkYXRlRW50aXR5KF86IFJlYWRvbmx5PEVudGl0eVR5cGU+LCBuZXh0RW50aXR5OiBhbnkpOiBFbnRpdHlUeXBlIHtcbiAgICByZXR1cm4gbmV4dEVudGl0eSBhcyBFbnRpdHlUeXBlO1xuICB9XG5cbiAgLy8gQGludGVybmFsXG4gIGFraXRhUHJlQWRkRW50aXR5KG5ld0VudGl0eTogYW55KTogRW50aXR5VHlwZSB7XG4gICAgcmV0dXJuIG5ld0VudGl0eSBhcyBFbnRpdHlUeXBlO1xuICB9XG5cbiAgLy8gQGludGVybmFsXG4gIGFraXRhUHJlQ2hlY2tFbnRpdHkobmV3RW50aXR5OiBSZWFkb25seTxFbnRpdHlUeXBlPik6IEVudGl0eVR5cGUge1xuICAgIHJldHVybiBuZXdFbnRpdHk7XG4gIH1cblxuICBwcml2YXRlIGdldCBpZHMoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3ZhbHVlKCkuaWRzO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXQgZW50aXRpZXMoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3ZhbHVlKCkuZW50aXRpZXM7XG4gIH1cblxuICBwcml2YXRlIGdldCBhY3RpdmUoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3ZhbHVlKCkuYWN0aXZlO1xuICB9XG5cbiAgcHJpdmF0ZSBfc2V0QWN0aXZlKGlkczogT3JBcnJheTxJRFR5cGU+KSB7XG4gICAgdGhpcy5fc2V0U3RhdGUoc3RhdGUgPT4ge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgIGFjdGl2ZTogaWRzXG4gICAgICB9O1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBoYW5kbGVVSUNyZWF0aW9uKGFkZCA9IGZhbHNlKSB7XG4gICAgY29uc3QgaWRzID0gdGhpcy5pZHM7XG4gICAgY29uc3QgaXNGdW5jID0gaXNGdW5jdGlvbih0aGlzLnVpLl9ha2l0YUNyZWF0ZUVudGl0eUZuKTtcbiAgICBsZXQgdWlFbnRpdGllcztcbiAgICBjb25zdCBjcmVhdGVGbiA9IGlkID0+IHtcbiAgICAgIGNvbnN0IGN1cnJlbnQgPSB0aGlzLmVudGl0aWVzW2lkXTtcbiAgICAgIGNvbnN0IHVpID0gaXNGdW5jID8gdGhpcy51aS5fYWtpdGFDcmVhdGVFbnRpdHlGbihjdXJyZW50KSA6IHRoaXMudWkuX2FraXRhQ3JlYXRlRW50aXR5Rm47XG4gICAgICByZXR1cm4ge1xuICAgICAgICBbdGhpcy5pZEtleV06IGN1cnJlbnRbdGhpcy5pZEtleV0sXG4gICAgICAgIC4uLnVpXG4gICAgICB9O1xuICAgIH07XG5cbiAgICBpZiAoYWRkKSB7XG4gICAgICB1aUVudGl0aWVzID0gdGhpcy5pZHMuZmlsdGVyKGlkID0+IGlzVW5kZWZpbmVkKHRoaXMudWkuZW50aXRpZXNbaWRdKSkubWFwKGNyZWF0ZUZuKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdWlFbnRpdGllcyA9IGlkcy5tYXAoY3JlYXRlRm4pO1xuICAgIH1cblxuICAgIGFkZCA/IHRoaXMudWkuYWRkKHVpRW50aXRpZXMpIDogdGhpcy51aS5zZXQodWlFbnRpdGllcyk7XG4gIH1cblxuICBwcml2YXRlIGhhc0luaXRpYWxVSVN0YXRlKCkge1xuICAgIHJldHVybiB0aGlzLmhhc1VJU3RvcmUoKSAmJiBpc1VuZGVmaW5lZCh0aGlzLnVpLl9ha2l0YUNyZWF0ZUVudGl0eUZuKSA9PT0gZmFsc2U7XG4gIH1cblxuICBwcml2YXRlIGhhbmRsZVVJUmVtb3ZlKGlkczogSURUeXBlW10pIHtcbiAgICBpZiAodGhpcy5oYXNVSVN0b3JlKCkpIHtcbiAgICAgIHRoaXMudWkucmVtb3ZlKGlkcyk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBoYXNVSVN0b3JlKCkge1xuICAgIHJldHVybiB0aGlzLnVpIGluc3RhbmNlb2YgRW50aXR5VUlTdG9yZTtcbiAgfVxufVxuXG4vLyBAaW50ZXJuYWxcbmV4cG9ydCBjbGFzcyBFbnRpdHlVSVN0b3JlPFVJU3RhdGUsIERFUFJFQ0FURUQgPSBhbnk+IGV4dGVuZHMgRW50aXR5U3RvcmU8VUlTdGF0ZT4ge1xuICBfYWtpdGFDcmVhdGVFbnRpdHlGbjogRW50aXR5VUlDcmVhdGVGbjtcblxuICBjb25zdHJ1Y3Rvcihpbml0aWFsU3RhdGUgPSB7fSwgc3RvcmVDb25maWc6IFBhcnRpYWw8U3RvcmVDb25maWdPcHRpb25zPiA9IHt9KSB7XG4gICAgc3VwZXIoaW5pdGlhbFN0YXRlLCBzdG9yZUNvbmZpZyk7XG4gIH1cblxuICAvKipcbiAgICpcbiAgICogU2V0IHRoZSBpbml0aWFsIFVJIGVudGl0eSBzdGF0ZS4gVGhpcyBmdW5jdGlvbiB3aWxsIGRldGVybWluZSB0aGUgZW50aXR5J3NcbiAgICogaW5pdGlhbCBzdGF0ZSB3aGVuIHdlIGNhbGwgYHNldCgpYCBvciBgYWRkKClgLlxuICAgKlxuICAgKiBAZXhhbXBsZVxuICAgKlxuICAgKiBjb25zdHJ1Y3RvcigpIHtcbiAgICogICBzdXBlcigpO1xuICAgKiAgIHRoaXMuY3JlYXRlVUlTdG9yZSgpLnNldEluaXRpYWxFbnRpdHlTdGF0ZShlbnRpdHkgPT4gKHsgaXNMb2FkaW5nOiBmYWxzZSwgaXNPcGVuOiB0cnVlIH0pKTtcbiAgICogICB0aGlzLmNyZWF0ZVVJU3RvcmUoKS5zZXRJbml0aWFsRW50aXR5U3RhdGUoeyBpc0xvYWRpbmc6IGZhbHNlLCBpc09wZW46IHRydWUgfSk7XG4gICAqIH1cbiAgICpcbiAgICovXG4gIHNldEluaXRpYWxFbnRpdHlTdGF0ZTxFbnRpdHlVSSA9IGFueSwgRW50aXR5ID0gYW55PihjcmVhdGVGbjogRW50aXR5VUlDcmVhdGVGbjxFbnRpdHlVSSwgRW50aXR5Pikge1xuICAgIHRoaXMuX2FraXRhQ3JlYXRlRW50aXR5Rm4gPSBjcmVhdGVGbjtcbiAgfVxufVxuIl19