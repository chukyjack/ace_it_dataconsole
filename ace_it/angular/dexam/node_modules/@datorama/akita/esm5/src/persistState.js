/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingOverride,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { filter, skip } from 'rxjs/operators';
import { from, isObservable, of, ReplaySubject } from 'rxjs';
import { isFunction } from './isFunction';
import { AkitaError } from './errors';
import { __stores__ } from './stores';
import { getValue } from './getValueByString';
import { setAction } from './actions';
import { setValue } from './setValueByString';
import { $$addStore, $$deleteStore } from './dispatchers';
import { isNil } from './isNil';
import { isObject } from './isObject';
import { isNotBrowser } from './root';
/** @type {?} */
var skipStorageUpdate = false;
/** @type {?} */
var _persistStateInit = new ReplaySubject(1);
/**
 * @return {?}
 */
export function selectPersistStateInit() {
    return _persistStateInit.asObservable();
}
/**
 * @param {?} skip
 * @return {?}
 */
export function setSkipStorageUpdate(skip) {
    skipStorageUpdate = skip;
}
/**
 * @return {?}
 */
export function getSkipStorageUpdate() {
    return skipStorageUpdate;
}
/**
 * @record
 */
export function PersistStateStorage() { }
if (false) {
    /**
     * @param {?} key
     * @return {?}
     */
    PersistStateStorage.prototype.getItem = function (key) { };
    /**
     * @param {?} key
     * @param {?} value
     * @return {?}
     */
    PersistStateStorage.prototype.setItem = function (key, value) { };
    /**
     * @return {?}
     */
    PersistStateStorage.prototype.clear = function () { };
}
/**
 * @param {?} v
 * @return {?}
 */
function isPromise(v) {
    return v && isFunction(v.then);
}
/**
 * @param {?} asyncOrValue
 * @return {?}
 */
function observify(asyncOrValue) {
    if (isPromise(asyncOrValue) || isObservable(asyncOrValue)) {
        return from(asyncOrValue);
    }
    return of(asyncOrValue);
}
/**
 * @record
 */
export function PersistStateParams() { }
if (false) {
    /**
     * The storage key
     * @type {?}
     */
    PersistStateParams.prototype.key;
    /**
     * Whether to enable persistState in a non-browser environment
     * @type {?}
     */
    PersistStateParams.prototype.enableInNonBrowser;
    /**
     * Storage strategy to use. This defaults to LocalStorage but you can pass SessionStorage or anything that implements the StorageEngine API.
     * @type {?}
     */
    PersistStateParams.prototype.storage;
    /**
     * Custom deserializer. Defaults to JSON.parse
     * @type {?}
     */
    PersistStateParams.prototype.deserialize;
    /**
     * Custom serializer, defaults to JSON.stringify
     * @type {?}
     */
    PersistStateParams.prototype.serialize;
    /**
     * By default the whole state is saved to storage, use this param to include only the stores you need.
     * Pay attention that you can't use both include and exclude
     * @type {?}
     */
    PersistStateParams.prototype.include;
    /**
     *  By default the whole state is saved to storage, use this param to exclude stores that you don't need.
     *  Pay attention that you can't use both include and exclude
     * @type {?}
     */
    PersistStateParams.prototype.exclude;
    /** @type {?} */
    PersistStateParams.prototype.skipStorageUpdate;
    /** @type {?} */
    PersistStateParams.prototype.preStorageUpdateOperator;
    /**
     * Whether to persist a dynamic store upon destroy
     * @type {?}
     */
    PersistStateParams.prototype.persistOnDestroy;
    /**
     * @param {?} storeName
     * @param {?} state
     * @return {?}
     */
    PersistStateParams.prototype.preStorageUpdate = function (storeName, state) { };
    /**
     * @param {?} storeName
     * @param {?} state
     * @return {?}
     */
    PersistStateParams.prototype.preStoreUpdate = function (storeName, state) { };
}
/**
 * @param {?=} params
 * @return {?}
 */
export function persistState(params) {
    /** @type {?} */
    var defaults = {
        key: 'AkitaStores',
        enableInNonBrowser: false,
        storage: typeof localStorage === 'undefined' ? params.storage : localStorage,
        deserialize: JSON.parse,
        serialize: JSON.stringify,
        include: [],
        /**
         * @deprecated use include with a callback
         */
        exclude: [],
        persistOnDestroy: false,
        preStorageUpdate: (/**
         * @param {?} storeName
         * @param {?} state
         * @return {?}
         */
        function (storeName, state) {
            return state;
        }),
        preStoreUpdate: (/**
         * @param {?} storeName
         * @param {?} state
         * @return {?}
         */
        function (storeName, state) {
            return state;
        }),
        skipStorageUpdate: getSkipStorageUpdate,
        preStorageUpdateOperator: (/**
         * @return {?}
         */
        function () { return (/**
         * @param {?} source
         * @return {?}
         */
        function (source) { return source; }); })
    };
    var _a = Object.assign({}, defaults, params), storage = _a.storage, enableInNonBrowser = _a.enableInNonBrowser, deserialize = _a.deserialize, serialize = _a.serialize, include = _a.include, exclude = _a.exclude, key = _a.key, preStorageUpdate = _a.preStorageUpdate, persistOnDestroy = _a.persistOnDestroy, preStorageUpdateOperator = _a.preStorageUpdateOperator, preStoreUpdate = _a.preStoreUpdate, skipStorageUpdate = _a.skipStorageUpdate;
    if (isNotBrowser && !enableInNonBrowser)
        return;
    /** @type {?} */
    var hasInclude = include.length > 0;
    /** @type {?} */
    var hasExclude = exclude.length > 0;
    /** @type {?} */
    var includeStores;
    if (hasInclude && hasExclude) {
        throw new AkitaError("You can't use both include and exclude");
    }
    if (hasInclude) {
        includeStores = include.reduce((/**
         * @param {?} acc
         * @param {?} path
         * @return {?}
         */
        function (acc, path) {
            if (isFunction(path)) {
                acc.fns.push(path);
            }
            else {
                /** @type {?} */
                var storeName = path.split('.')[0];
                acc[storeName] = path;
            }
            return acc;
        }), { fns: [] });
    }
    /** @type {?} */
    var stores = {};
    /** @type {?} */
    var acc = {};
    /** @type {?} */
    var subscriptions = [];
    /** @type {?} */
    var buffer = [];
    /**
     * @param {?} v
     * @return {?}
     */
    function _save(v) {
        observify(v).subscribe((/**
         * @return {?}
         */
        function () {
            /** @type {?} */
            var next = buffer.shift();
            next && _save(next);
        }));
    }
    // when we use the local/session storage we perform the serialize, otherwise we let the passed storage implementation to do it
    /** @type {?} */
    var isLocalStorage = typeof localStorage !== 'undefined' && (storage === localStorage || storage === sessionStorage);
    observify(storage.getItem(key)).subscribe((/**
     * @param {?} value
     * @return {?}
     */
    function (value) {
        /** @type {?} */
        var storageState = isObject(value) ? value : deserialize(value || '{}');
        /**
         * @param {?} storeCache
         * @return {?}
         */
        function save(storeCache) {
            storageState['$cache'] = tslib_1.__assign({}, (storageState['$cache'] || {}), storeCache);
            storageState = Object.assign({}, storageState, acc);
            buffer.push(storage.setItem(key, isLocalStorage ? serialize(storageState) : storageState));
            _save(buffer.shift());
        }
        /**
         * @param {?} storeName
         * @param {?} path
         * @return {?}
         */
        function subscribe(storeName, path) {
            stores[storeName] = __stores__[storeName]
                ._select((/**
             * @param {?} state
             * @return {?}
             */
            function (state) { return getValue(state, path); }))
                .pipe(skip(1), filter((/**
             * @return {?}
             */
            function () { return skipStorageUpdate() === false; })), preStorageUpdateOperator())
                .subscribe((/**
             * @param {?} data
             * @return {?}
             */
            function (data) {
                acc[storeName] = preStorageUpdate(storeName, data);
                Promise.resolve().then((/**
                 * @return {?}
                 */
                function () {
                    var _a;
                    return save((_a = {}, _a[storeName] = __stores__[storeName]._cache().getValue(), _a));
                }));
            }));
        }
        /**
         * @param {?} storeName
         * @param {?} store
         * @param {?} path
         * @return {?}
         */
        function setInitial(storeName, store, path) {
            if (storeName in storageState) {
                setAction('@PersistState');
                store._setState((/**
                 * @param {?} state
                 * @return {?}
                 */
                function (state) {
                    return setValue(state, path, preStoreUpdate(storeName, storageState[storeName]));
                }));
                /** @type {?} */
                var hasCache = storageState['$cache'] ? storageState['$cache'][storeName] : false;
                __stores__[storeName].setHasCache(hasCache, { restartTTL: true });
            }
        }
        subscriptions.push($$deleteStore.subscribe((/**
         * @param {?} storeName
         * @return {?}
         */
        function (storeName) {
            var _a;
            if (stores[storeName]) {
                if (persistOnDestroy === false) {
                    save((_a = {}, _a[storeName] = false, _a));
                }
                stores[storeName].unsubscribe();
                delete stores[storeName];
            }
        })));
        subscriptions.push($$addStore.subscribe((/**
         * @param {?} storeName
         * @return {?}
         */
        function (storeName) {
            if (storeName === 'router' || (hasExclude && exclude.includes(storeName))) {
                return;
            }
            /** @type {?} */
            var store = __stores__[storeName];
            if (hasInclude) {
                /** @type {?} */
                var path = includeStores[storeName];
                if (!path) {
                    /** @type {?} */
                    var passPredicate = includeStores.fns.some((/**
                     * @param {?} fn
                     * @return {?}
                     */
                    function (fn) { return fn(storeName); }));
                    if (passPredicate) {
                        path = storeName;
                    }
                    else {
                        return;
                    }
                }
                setInitial(storeName, store, path);
                subscribe(storeName, path);
            }
            else {
                setInitial(storeName, store, storeName);
                subscribe(storeName, storeName);
            }
        })));
        _persistStateInit.next();
    }));
    return {
        destroy: /**
         * @return {?}
         */
        function () {
            subscriptions.forEach((/**
             * @param {?} s
             * @return {?}
             */
            function (s) { return s.unsubscribe(); }));
            for (var i = 0, keys = Object.keys(stores); i < keys.length; i++) {
                /** @type {?} */
                var storeName = keys[i];
                stores[storeName].unsubscribe();
            }
            stores = {};
        },
        clear: /**
         * @return {?}
         */
        function () {
            storage.clear();
        },
        clearStore: /**
         * @param {?=} storeName
         * @return {?}
         */
        function (storeName) {
            if (isNil(storeName)) {
                /** @type {?} */
                var value_1 = observify(storage.setItem(key, '{}'));
                value_1.subscribe();
                return;
            }
            /** @type {?} */
            var value = storage.getItem(key);
            observify(value).subscribe((/**
             * @param {?} v
             * @return {?}
             */
            function (v) {
                /** @type {?} */
                var storageState = deserialize(v || '{}');
                if (storageState[storeName]) {
                    delete storageState[storeName];
                    /** @type {?} */
                    var value_2 = observify(storage.setItem(key, serialize(storageState)));
                    value_2.subscribe();
                }
            }));
        }
    };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGVyc2lzdFN0YXRlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vQGRhdG9yYW1hL2FraXRhLyIsInNvdXJjZXMiOlsic3JjL3BlcnNpc3RTdGF0ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsSUFBSSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDOUMsT0FBTyxFQUFFLElBQUksRUFBRSxZQUFZLEVBQUUsRUFBRSxFQUFvQixhQUFhLEVBQWdCLE1BQU0sTUFBTSxDQUFDO0FBRTdGLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDMUMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUN0QyxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUM5QyxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sV0FBVyxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUM5QyxPQUFPLEVBQUUsVUFBVSxFQUFFLGFBQWEsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMxRCxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ2hDLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxZQUFZLENBQUM7QUFDdEMsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLFFBQVEsQ0FBQzs7SUFFbEMsaUJBQWlCLEdBQUcsS0FBSzs7SUFFdkIsaUJBQWlCLEdBQUcsSUFBSSxhQUFhLENBQUMsQ0FBQyxDQUFDOzs7O0FBRTlDLE1BQU0sVUFBVSxzQkFBc0I7SUFDcEMsT0FBTyxpQkFBaUIsQ0FBQyxZQUFZLEVBQUUsQ0FBQztBQUMxQyxDQUFDOzs7OztBQUVELE1BQU0sVUFBVSxvQkFBb0IsQ0FBQyxJQUFhO0lBQ2hELGlCQUFpQixHQUFHLElBQUksQ0FBQztBQUMzQixD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VTs7OztrQkFBQyxTQUFrQjtZQUMzQixJQUFJLEtBQUssQ0FBQyxTQUFTLENBQUMsRUFBRTs7b0JBQ2QsT0FBSyxHQUFHLFNBQVMsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQztnQkFDbkQsT0FBSyxDQUFDLFNBQVMsRUFBRSxDQUFDO2dCQUNsQixPQUFPO2FBQ1I7O2dCQUNLLEtBQUssR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQztZQUNsQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUMsU0FBUzs7OztZQUFDLFVBQUEsQ0FBQzs7b0JBQ3BCLFlBQVksR0FBRyxXQUFXLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQztnQkFFM0MsSUFBSSxZQUFZLENBQUMsU0FBUyxDQUFDLEVBQUU7b0JBQzNCLE9BQU8sWUFBWSxDQUFDLFNBQVMsQ0FBQyxDQUFDOzt3QkFDekIsT0FBSyxHQUFHLFNBQVMsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxTQUFTLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztvQkFDdEUsT0FBSyxDQUFDLFNBQVMsRUFBRSxDQUFDO2lCQUNuQjtZQUNILENBQUMsRUFBQyxDQUFDO1FBQ0wsQ0FBQztLQUNGLENBQUM7QUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZmlsdGVyLCBza2lwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgZnJvbSwgaXNPYnNlcnZhYmxlLCBvZiwgT3BlcmF0b3JGdW5jdGlvbiwgUmVwbGF5U3ViamVjdCwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBIYXNoTWFwLCBNYXliZUFzeW5jIH0gZnJvbSAnLi90eXBlcyc7XG5pbXBvcnQgeyBpc0Z1bmN0aW9uIH0gZnJvbSAnLi9pc0Z1bmN0aW9uJztcbmltcG9ydCB7IEFraXRhRXJyb3IgfSBmcm9tICcuL2Vycm9ycyc7XG5pbXBvcnQgeyBfX3N0b3Jlc19fIH0gZnJvbSAnLi9zdG9yZXMnO1xuaW1wb3J0IHsgZ2V0VmFsdWUgfSBmcm9tICcuL2dldFZhbHVlQnlTdHJpbmcnO1xuaW1wb3J0IHsgc2V0QWN0aW9uIH0gZnJvbSAnLi9hY3Rpb25zJztcbmltcG9ydCB7IHNldFZhbHVlIH0gZnJvbSAnLi9zZXRWYWx1ZUJ5U3RyaW5nJztcbmltcG9ydCB7ICQkYWRkU3RvcmUsICQkZGVsZXRlU3RvcmUgfSBmcm9tICcuL2Rpc3BhdGNoZXJzJztcbmltcG9ydCB7IGlzTmlsIH0gZnJvbSAnLi9pc05pbCc7XG5pbXBvcnQgeyBpc09iamVjdCB9IGZyb20gJy4vaXNPYmplY3QnO1xuaW1wb3J0IHsgaXNOb3RCcm93c2VyIH0gZnJvbSAnLi9yb290JztcblxubGV0IHNraXBTdG9yYWdlVXBkYXRlID0gZmFsc2U7XG5cbmNvbnN0IF9wZXJzaXN0U3RhdGVJbml0ID0gbmV3IFJlcGxheVN1YmplY3QoMSk7XG5cbmV4cG9ydCBmdW5jdGlvbiBzZWxlY3RQZXJzaXN0U3RhdGVJbml0KCkge1xuICByZXR1cm4gX3BlcnNpc3RTdGF0ZUluaXQuYXNPYnNlcnZhYmxlKCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzZXRTa2lwU3RvcmFnZVVwZGF0ZShza2lwOiBib29sZWFuKSB7XG4gIHNraXBTdG9yYWdlVXBkYXRlID0gc2tpcDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFNraXBTdG9yYWdlVXBkYXRlKCkge1xuICByZXR1cm4gc2tpcFN0b3JhZ2VVcGRhdGU7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUGVyc2lzdFN0YXRlU3RvcmFnZSB7XG4gIGdldEl0ZW0oa2V5OiBzdHJpbmcpOiBNYXliZUFzeW5jO1xuXG4gIHNldEl0ZW0oa2V5OiBzdHJpbmcsIHZhbHVlOiBhbnkpOiBNYXliZUFzeW5jO1xuXG4gIGNsZWFyKCk6IHZvaWQ7XG59XG5cbmZ1bmN0aW9uIGlzUHJvbWlzZSh2OiBhbnkpIHtcbiAgcmV0dXJuIHYgJiYgaXNGdW5jdGlvbih2LnRoZW4pO1xufVxuXG5mdW5jdGlvbiBvYnNlcnZpZnkoYXN5bmNPclZhbHVlOiBhbnkpIHtcbiAgaWYgKGlzUHJvbWlzZShhc3luY09yVmFsdWUpIHx8IGlzT2JzZXJ2YWJsZShhc3luY09yVmFsdWUpKSB7XG4gICAgcmV0dXJuIGZyb20oYXN5bmNPclZhbHVlKTtcbiAgfVxuXG4gIHJldHVybiBvZihhc3luY09yVmFsdWUpO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFBlcnNpc3RTdGF0ZVBhcmFtcyB7XG4gIC8qKiBUaGUgc3RvcmFnZSBrZXkgKi9cbiAga2V5OiBzdHJpbmc7XG4gIC8qKiBXaGV0aGVyIHRvIGVuYWJsZSBwZXJzaXN0U3RhdGUgaW4gYSBub24tYnJvd3NlciBlbnZpcm9ubWVudCAqL1xuICBlbmFibGVJbk5vbkJyb3dzZXI6IGJvb2xlYW47XG4gIC8qKiBTdG9yYWdlIHN0cmF0ZWd5IHRvIHVzZS4gVGhpcyBkZWZhdWx0cyB0byBMb2NhbFN0b3JhZ2UgYnV0IHlvdSBjYW4gcGFzcyBTZXNzaW9uU3RvcmFnZSBvciBhbnl0aGluZyB0aGF0IGltcGxlbWVudHMgdGhlIFN0b3JhZ2VFbmdpbmUgQVBJLiAqL1xuICBzdG9yYWdlOiBQZXJzaXN0U3RhdGVTdG9yYWdlO1xuICAvKiogQ3VzdG9tIGRlc2VyaWFsaXplci4gRGVmYXVsdHMgdG8gSlNPTi5wYXJzZSAqL1xuICBkZXNlcmlhbGl6ZTogRnVuY3Rpb247XG4gIC8qKiBDdXN0b20gc2VyaWFsaXplciwgZGVmYXVsdHMgdG8gSlNPTi5zdHJpbmdpZnkgKi9cbiAgc2VyaWFsaXplOiBGdW5jdGlvbjtcbiAgLyoqXG4gICAqIEJ5IGRlZmF1bHQgdGhlIHdob2xlIHN0YXRlIGlzIHNhdmVkIHRvIHN0b3JhZ2UsIHVzZSB0aGlzIHBhcmFtIHRvIGluY2x1ZGUgb25seSB0aGUgc3RvcmVzIHlvdSBuZWVkLlxuICAgKiBQYXkgYXR0ZW50aW9uIHRoYXQgeW91IGNhbid0IHVzZSBib3RoIGluY2x1ZGUgYW5kIGV4Y2x1ZGVcbiAgICovXG4gIGluY2x1ZGU6IChzdHJpbmcgfCAoKHN0b3JlTmFtZTogc3RyaW5nKSA9PiBib29sZWFuKSlbXTtcbiAgLyoqXG4gICAqICBCeSBkZWZhdWx0IHRoZSB3aG9sZSBzdGF0ZSBpcyBzYXZlZCB0byBzdG9yYWdlLCB1c2UgdGhpcyBwYXJhbSB0byBleGNsdWRlIHN0b3JlcyB0aGF0IHlvdSBkb24ndCBuZWVkLlxuICAgKiAgUGF5IGF0dGVudGlvbiB0aGF0IHlvdSBjYW4ndCB1c2UgYm90aCBpbmNsdWRlIGFuZCBleGNsdWRlXG4gICAqL1xuICBleGNsdWRlOiBzdHJpbmdbXTtcblxuICBwcmVTdG9yYWdlVXBkYXRlKHN0b3JlTmFtZTogc3RyaW5nLCBzdGF0ZTogYW55KTogYW55O1xuXG4gIHByZVN0b3JlVXBkYXRlKHN0b3JlTmFtZTogc3RyaW5nLCBzdGF0ZTogYW55KTogYW55O1xuXG4gIHNraXBTdG9yYWdlVXBkYXRlOiAoKSA9PiBib29sZWFuO1xuICBwcmVTdG9yYWdlVXBkYXRlT3BlcmF0b3I6ICgpID0+IE9wZXJhdG9yRnVuY3Rpb248YW55LCBhbnk+O1xuICAvKiogV2hldGhlciB0byBwZXJzaXN0IGEgZHluYW1pYyBzdG9yZSB1cG9uIGRlc3Ryb3kgKi9cbiAgcGVyc2lzdE9uRGVzdHJveTogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHBlcnNpc3RTdGF0ZShwYXJhbXM/OiBQYXJ0aWFsPFBlcnNpc3RTdGF0ZVBhcmFtcz4pIHtcbiAgY29uc3QgZGVmYXVsdHM6IFBlcnNpc3RTdGF0ZVBhcmFtcyA9IHtcbiAgICBrZXk6ICdBa2l0YVN0b3JlcycsXG4gICAgZW5hYmxlSW5Ob25Ccm93c2VyOiBmYWxzZSxcbiAgICBzdG9yYWdlOiB0eXBlb2YgbG9jYWxTdG9yYWdlID09PSAndW5kZWZpbmVkJyA/IHBhcmFtcy5zdG9yYWdlIDogbG9jYWxTdG9yYWdlLFxuICAgIGRlc2VyaWFsaXplOiBKU09OLnBhcnNlLFxuICAgIHNlcmlhbGl6ZTogSlNPTi5zdHJpbmdpZnksXG4gICAgaW5jbHVkZTogW10sXG4gICAgLyoqXG4gICAgICogQGRlcHJlY2F0ZWQgdXNlIGluY2x1ZGUgd2l0aCBhIGNhbGxiYWNrXG4gICAgICovXG4gICAgZXhjbHVkZTogW10sXG4gICAgcGVyc2lzdE9uRGVzdHJveTogZmFsc2UsXG4gICAgcHJlU3RvcmFnZVVwZGF0ZTogZnVuY3Rpb24oc3RvcmVOYW1lLCBzdGF0ZSkge1xuICAgICAgcmV0dXJuIHN0YXRlO1xuICAgIH0sXG4gICAgcHJlU3RvcmVVcGRhdGU6IGZ1bmN0aW9uKHN0b3JlTmFtZSwgc3RhdGUpIHtcbiAgICAgIHJldHVybiBzdGF0ZTtcbiAgICB9LFxuICAgIHNraXBTdG9yYWdlVXBkYXRlOiBnZXRTa2lwU3RvcmFnZVVwZGF0ZSxcbiAgICBwcmVTdG9yYWdlVXBkYXRlT3BlcmF0b3I6ICgpID0+IHNvdXJjZSA9PiBzb3VyY2VcbiAgfTtcblxuICBjb25zdCB7IHN0b3JhZ2UsIGVuYWJsZUluTm9uQnJvd3NlciwgZGVzZXJpYWxpemUsIHNlcmlhbGl6ZSwgaW5jbHVkZSwgZXhjbHVkZSwga2V5LCBwcmVTdG9yYWdlVXBkYXRlLCBwZXJzaXN0T25EZXN0cm95LCBwcmVTdG9yYWdlVXBkYXRlT3BlcmF0b3IsIHByZVN0b3JlVXBkYXRlLCBza2lwU3RvcmFnZVVwZGF0ZSB9ID0gT2JqZWN0LmFzc2lnbihcbiAgICB7fSxcbiAgICBkZWZhdWx0cyxcbiAgICBwYXJhbXNcbiAgKTtcblxuICBpZiAoaXNOb3RCcm93c2VyICYmICFlbmFibGVJbk5vbkJyb3dzZXIpIHJldHVybjtcblxuICBjb25zdCBoYXNJbmNsdWRlID0gaW5jbHVkZS5sZW5ndGggPiAwO1xuICBjb25zdCBoYXNFeGNsdWRlID0gZXhjbHVkZS5sZW5ndGggPiAwO1xuICBsZXQgaW5jbHVkZVN0b3JlczogeyBmbnM6IEZ1bmN0aW9uW107IFtrZXk6IHN0cmluZ106IEZ1bmN0aW9uW10gfCBzdHJpbmcgfTtcblxuICBpZiAoaGFzSW5jbHVkZSAmJiBoYXNFeGNsdWRlKSB7XG4gICAgdGhyb3cgbmV3IEFraXRhRXJyb3IoXCJZb3UgY2FuJ3QgdXNlIGJvdGggaW5jbHVkZSBhbmQgZXhjbHVkZVwiKTtcbiAgfVxuXG4gIGlmIChoYXNJbmNsdWRlKSB7XG4gICAgaW5jbHVkZVN0b3JlcyA9IGluY2x1ZGUucmVkdWNlKFxuICAgICAgKGFjYywgcGF0aCkgPT4ge1xuICAgICAgICBpZiAoaXNGdW5jdGlvbihwYXRoKSkge1xuICAgICAgICAgIGFjYy5mbnMucHVzaChwYXRoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zdCBzdG9yZU5hbWUgPSBwYXRoLnNwbGl0KCcuJylbMF07XG4gICAgICAgICAgYWNjW3N0b3JlTmFtZV0gPSBwYXRoO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBhY2M7XG4gICAgICB9LFxuICAgICAgeyBmbnM6IFtdIH1cbiAgICApO1xuICB9XG5cbiAgbGV0IHN0b3JlczogSGFzaE1hcDxTdWJzY3JpcHRpb24+ID0ge307XG4gIGxldCBhY2MgPSB7fTtcbiAgbGV0IHN1YnNjcmlwdGlvbnM6IFN1YnNjcmlwdGlvbltdID0gW107XG5cbiAgY29uc3QgYnVmZmVyID0gW107XG5cbiAgZnVuY3Rpb24gX3NhdmUodjogYW55KSB7XG4gICAgb2JzZXJ2aWZ5KHYpLnN1YnNjcmliZSgoKSA9PiB7XG4gICAgICBjb25zdCBuZXh0ID0gYnVmZmVyLnNoaWZ0KCk7XG4gICAgICBuZXh0ICYmIF9zYXZlKG5leHQpO1xuICAgIH0pO1xuICB9XG5cbiAgLy8gd2hlbiB3ZSB1c2UgdGhlIGxvY2FsL3Nlc3Npb24gc3RvcmFnZSB3ZSBwZXJmb3JtIHRoZSBzZXJpYWxpemUsIG90aGVyd2lzZSB3ZSBsZXQgdGhlIHBhc3NlZCBzdG9yYWdlIGltcGxlbWVudGF0aW9uIHRvIGRvIGl0XG4gIGNvbnN0IGlzTG9jYWxTdG9yYWdlID0gdHlwZW9mIGxvY2FsU3RvcmFnZSAhPT0gJ3VuZGVmaW5lZCcgJiYgKHN0b3JhZ2UgPT09IGxvY2FsU3RvcmFnZSB8fCBzdG9yYWdlID09PSBzZXNzaW9uU3RvcmFnZSk7XG5cbiAgb2JzZXJ2aWZ5KHN0b3JhZ2UuZ2V0SXRlbShrZXkpKS5zdWJzY3JpYmUoKHZhbHVlOiBhbnkpID0+IHtcbiAgICBsZXQgc3RvcmFnZVN0YXRlID0gaXNPYmplY3QodmFsdWUpID8gdmFsdWUgOiBkZXNlcmlhbGl6ZSh2YWx1ZSB8fCAne30nKTtcblxuICAgIGZ1bmN0aW9uIHNhdmUoc3RvcmVDYWNoZSkge1xuICAgICAgc3RvcmFnZVN0YXRlWyckY2FjaGUnXSA9IHsgLi4uKHN0b3JhZ2VTdGF0ZVsnJGNhY2hlJ10gfHwge30pLCAuLi5zdG9yZUNhY2hlIH07XG4gICAgICBzdG9yYWdlU3RhdGUgPSBPYmplY3QuYXNzaWduKHt9LCBzdG9yYWdlU3RhdGUsIGFjYyk7XG5cbiAgICAgIGJ1ZmZlci5wdXNoKHN0b3JhZ2Uuc2V0SXRlbShrZXksIGlzTG9jYWxTdG9yYWdlID8gc2VyaWFsaXplKHN0b3JhZ2VTdGF0ZSkgOiBzdG9yYWdlU3RhdGUpKTtcbiAgICAgIF9zYXZlKGJ1ZmZlci5zaGlmdCgpKTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiBzdWJzY3JpYmUoc3RvcmVOYW1lLCBwYXRoKSB7XG4gICAgICBzdG9yZXNbc3RvcmVOYW1lXSA9IF9fc3RvcmVzX19bc3RvcmVOYW1lXVxuICAgICAgICAuX3NlbGVjdChzdGF0ZSA9PiBnZXRWYWx1ZShzdGF0ZSwgcGF0aCkpXG4gICAgICAgIC5waXBlKFxuICAgICAgICAgIHNraXAoMSksXG4gICAgICAgICAgZmlsdGVyKCgpID0+IHNraXBTdG9yYWdlVXBkYXRlKCkgPT09IGZhbHNlKSxcbiAgICAgICAgICBwcmVTdG9yYWdlVXBkYXRlT3BlcmF0b3IoKVxuICAgICAgICApXG4gICAgICAgIC5zdWJzY3JpYmUoZGF0YSA9PiB7XG4gICAgICAgICAgYWNjW3N0b3JlTmFtZV0gPSBwcmVTdG9yYWdlVXBkYXRlKHN0b3JlTmFtZSwgZGF0YSk7XG4gICAgICAgICAgUHJvbWlzZS5yZXNvbHZlKCkudGhlbigoKSA9PiBzYXZlKHsgW3N0b3JlTmFtZV06IF9fc3RvcmVzX19bc3RvcmVOYW1lXS5fY2FjaGUoKS5nZXRWYWx1ZSgpIH0pKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gc2V0SW5pdGlhbChzdG9yZU5hbWUsIHN0b3JlLCBwYXRoKSB7XG4gICAgICBpZiAoc3RvcmVOYW1lIGluIHN0b3JhZ2VTdGF0ZSkge1xuICAgICAgICBzZXRBY3Rpb24oJ0BQZXJzaXN0U3RhdGUnKTtcbiAgICAgICAgc3RvcmUuX3NldFN0YXRlKHN0YXRlID0+IHtcbiAgICAgICAgICByZXR1cm4gc2V0VmFsdWUoc3RhdGUsIHBhdGgsIHByZVN0b3JlVXBkYXRlKHN0b3JlTmFtZSwgc3RvcmFnZVN0YXRlW3N0b3JlTmFtZV0pKTtcbiAgICAgICAgfSk7XG4gICAgICAgIGNvbnN0IGhhc0NhY2hlID0gc3RvcmFnZVN0YXRlWyckY2FjaGUnXSA/IHN0b3JhZ2VTdGF0ZVsnJGNhY2hlJ11bc3RvcmVOYW1lXSA6IGZhbHNlO1xuICAgICAgICBfX3N0b3Jlc19fW3N0b3JlTmFtZV0uc2V0SGFzQ2FjaGUoaGFzQ2FjaGUsIHsgcmVzdGFydFRUTDogdHJ1ZSB9KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBzdWJzY3JpcHRpb25zLnB1c2goXG4gICAgICAkJGRlbGV0ZVN0b3JlLnN1YnNjcmliZShzdG9yZU5hbWUgPT4ge1xuICAgICAgICBpZiAoc3RvcmVzW3N0b3JlTmFtZV0pIHtcbiAgICAgICAgICBpZiAocGVyc2lzdE9uRGVzdHJveSA9PT0gZmFsc2UpIHtcbiAgICAgICAgICAgIHNhdmUoeyBbc3RvcmVOYW1lXTogZmFsc2UgfSk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHN0b3Jlc1tzdG9yZU5hbWVdLnVuc3Vic2NyaWJlKCk7XG4gICAgICAgICAgZGVsZXRlIHN0b3Jlc1tzdG9yZU5hbWVdO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgICk7XG5cbiAgICBzdWJzY3JpcHRpb25zLnB1c2goXG4gICAgICAkJGFkZFN0b3JlLnN1YnNjcmliZShzdG9yZU5hbWUgPT4ge1xuICAgICAgICBpZiAoc3RvcmVOYW1lID09PSAncm91dGVyJyB8fCAoaGFzRXhjbHVkZSAmJiBleGNsdWRlLmluY2x1ZGVzKHN0b3JlTmFtZSkpKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3Qgc3RvcmUgPSBfX3N0b3Jlc19fW3N0b3JlTmFtZV07XG4gICAgICAgIGlmIChoYXNJbmNsdWRlKSB7XG4gICAgICAgICAgbGV0IHBhdGggPSBpbmNsdWRlU3RvcmVzW3N0b3JlTmFtZV07XG5cbiAgICAgICAgICBpZiAoIXBhdGgpIHtcbiAgICAgICAgICAgIGNvbnN0IHBhc3NQcmVkaWNhdGUgPSBpbmNsdWRlU3RvcmVzLmZucy5zb21lKGZuID0+IGZuKHN0b3JlTmFtZSkpO1xuICAgICAgICAgICAgaWYgKHBhc3NQcmVkaWNhdGUpIHtcbiAgICAgICAgICAgICAgcGF0aCA9IHN0b3JlTmFtZTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgICAgc2V0SW5pdGlhbChzdG9yZU5hbWUsIHN0b3JlLCBwYXRoKTtcbiAgICAgICAgICBzdWJzY3JpYmUoc3RvcmVOYW1lLCBwYXRoKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBzZXRJbml0aWFsKHN0b3JlTmFtZSwgc3RvcmUsIHN0b3JlTmFtZSk7XG4gICAgICAgICAgc3Vic2NyaWJlKHN0b3JlTmFtZSwgc3RvcmVOYW1lKTtcbiAgICAgICAgfVxuICAgICAgfSlcbiAgICApO1xuXG4gICAgX3BlcnNpc3RTdGF0ZUluaXQubmV4dCgpO1xuICB9KTtcblxuICByZXR1cm4ge1xuICAgIGRlc3Ryb3koKSB7XG4gICAgICBzdWJzY3JpcHRpb25zLmZvckVhY2gocyA9PiBzLnVuc3Vic2NyaWJlKCkpO1xuICAgICAgZm9yIChsZXQgaSA9IDAsIGtleXMgPSBPYmplY3Qua2V5cyhzdG9yZXMpOyBpIDwga2V5cy5sZW5ndGg7IGkrKykge1xuICAgICAgICBjb25zdCBzdG9yZU5hbWUgPSBrZXlzW2ldO1xuICAgICAgICBzdG9yZXNbc3RvcmVOYW1lXS51bnN1YnNjcmliZSgpO1xuICAgICAgfVxuICAgICAgc3RvcmVzID0ge307XG4gICAgfSxcbiAgICBjbGVhcigpIHtcbiAgICAgIHN0b3JhZ2UuY2xlYXIoKTtcbiAgICB9LFxuICAgIGNsZWFyU3RvcmUoc3RvcmVOYW1lPzogc3RyaW5nKSB7XG4gICAgICBpZiAoaXNOaWwoc3RvcmVOYW1lKSkge1xuICAgICAgICBjb25zdCB2YWx1ZSA9IG9ic2VydmlmeShzdG9yYWdlLnNldEl0ZW0oa2V5LCAne30nKSk7XG4gICAgICAgIHZhbHVlLnN1YnNjcmliZSgpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBjb25zdCB2YWx1ZSA9IHN0b3JhZ2UuZ2V0SXRlbShrZXkpO1xuICAgICAgb2JzZXJ2aWZ5KHZhbHVlKS5zdWJzY3JpYmUodiA9PiB7XG4gICAgICAgIGNvbnN0IHN0b3JhZ2VTdGF0ZSA9IGRlc2VyaWFsaXplKHYgfHwgJ3t9Jyk7XG5cbiAgICAgICAgaWYgKHN0b3JhZ2VTdGF0ZVtzdG9yZU5hbWVdKSB7XG4gICAgICAgICAgZGVsZXRlIHN0b3JhZ2VTdGF0ZVtzdG9yZU5hbWVdO1xuICAgICAgICAgIGNvbnN0IHZhbHVlID0gb2JzZXJ2aWZ5KHN0b3JhZ2Uuc2V0SXRlbShrZXksIHNlcmlhbGl6ZShzdG9yYWdlU3RhdGUpKSk7XG4gICAgICAgICAgdmFsdWUuc3Vic2NyaWJlKCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfTtcbn1cbiJdfQ==