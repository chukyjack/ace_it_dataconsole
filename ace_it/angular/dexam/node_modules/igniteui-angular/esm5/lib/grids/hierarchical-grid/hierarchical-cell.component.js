/**
 * @fileoverview added by tsickle
 * @suppress {checkTypes,extraRequire,missingReturn,unusedPrivateMembers,uselessCode} checked by tsc
 */
import * as tslib_1 from "tslib";
import { IgxGridCellComponent } from '../cell.component';
import { GridBaseAPIService } from '../api.service';
import { ChangeDetectorRef, ElementRef, ChangeDetectionStrategy, Component, HostListener, NgZone } from '@angular/core';
import { IgxHierarchicalSelectionAPIService } from './selection';
import { IgxGridSelectionService, IgxGridCRUDService } from '../../core/grid-selection';
import { HammerGesturesManager } from '../../core/touch';
var IgxHierarchicalGridCellComponent = /** @class */ (function (_super) {
    tslib_1.__extends(IgxHierarchicalGridCellComponent, _super);
    function IgxHierarchicalGridCellComponent(selectionService, crudService, gridAPI, selection, cdr, helement, zone, touchManager) {
        var _this = _super.call(this, selectionService, crudService, gridAPI, selection, cdr, helement, zone, touchManager) || this;
        _this.selectionService = selectionService;
        _this.crudService = crudService;
        _this.gridAPI = gridAPI;
        _this.selection = selection;
        _this.cdr = cdr;
        _this.helement = helement;
        _this.zone = zone;
        _this.hSelection = (/** @type {?} */ (selection));
        return _this;
    }
    /**
     * @return {?}
     */
    IgxHierarchicalGridCellComponent.prototype.ngOnInit = /**
     * @return {?}
     */
    function () {
        _super.prototype.ngOnInit.call(this);
        this._rootGrid = this._getRootGrid();
    };
    /**
     * @private
     * @return {?}
     */
    IgxHierarchicalGridCellComponent.prototype._getRootGrid = /**
     * @private
     * @return {?}
     */
    function () {
        /** @type {?} */
        var currGrid = this.grid;
        while (currGrid.parent) {
            currGrid = currGrid.parent;
        }
        return currGrid;
    };
    // TODO: Extend the new selection service to avoid complete traversal
    // TODO: Extend the new selection service to avoid complete traversal
    /**
     * @return {?}
     */
    IgxHierarchicalGridCellComponent.prototype._clearAllHighlights = 
    // TODO: Extend the new selection service to avoid complete traversal
    /**
     * @return {?}
     */
    function () {
        tslib_1.__spread([this._rootGrid], this._rootGrid.getChildGrids(true)).forEach(function (grid) {
            grid.selectionService.clear();
            grid.selectionService.activeElement = null;
            grid.nativeElement.classList.remove('igx-grid__tr--highlighted');
            grid.highlightedRowID = null;
            grid.cdr.markForCheck();
        });
    };
    /**
     * @hidden
     * @internal
     */
    /**
     * @hidden
     * \@internal
     * @param {?} event
     * @return {?}
     */
    IgxHierarchicalGridCellComponent.prototype.onFocus = /**
     * @hidden
     * \@internal
     * @param {?} event
     * @return {?}
     */
    function (event) {
        this._clearAllHighlights();
        /** @type {?} */
        var currentElement = this.grid.nativeElement;
        /** @type {?} */
        var parentGrid = this.grid;
        /** @type {?} */
        var childGrid;
        // add highligh to the current grid
        if (this._rootGrid.id !== currentElement.id) {
            currentElement.classList.add('igx-grid__tr--highlighted');
        }
        // add highligh to the current grid
        while (this._rootGrid.id !== parentGrid.id) {
            childGrid = parentGrid;
            parentGrid = parentGrid.parent;
            /** @type {?} */
            var parentRowID = parentGrid.hgridAPI.getParentRowId(childGrid);
            parentGrid.highlightedRowID = parentRowID;
        }
        _super.prototype.onFocus.call(this, event);
    };
    // TODO: Refactor
    /**
     * @hidden
     * @internal
     */
    // TODO: Refactor
    /**
     * @hidden
     * \@internal
     * @param {?} event
     * @return {?}
     */
    IgxHierarchicalGridCellComponent.prototype.dispatchEvent = 
    // TODO: Refactor
    /**
     * @hidden
     * \@internal
     * @param {?} event
     * @return {?}
     */
    function (event) {
        var _this = this;
        /** @type {?} */
        var key = event.key.toLowerCase();
        if (event.altKey) {
            /** @type {?} */
            var grid = this.gridAPI.grid;
            /** @type {?} */
            var state = this.gridAPI.grid.hierarchicalState;
            /** @type {?} */
            var collapse = this.row.expanded && (key === 'left' || key === 'arrowleft' || key === 'up' || key === 'arrowup');
            /** @type {?} */
            var expand = !this.row.expanded && (key === 'right' || key === 'arrowright' || key === 'down' || key === 'arrowdown');
            if (collapse) {
                grid.hierarchicalState = state.filter(function (v) {
                    return v.rowID !== _this.row.rowID;
                });
            }
            else if (expand) {
                state.push({ rowID: this.row.rowID });
                grid.hierarchicalState = tslib_1.__spread(state);
            }
            if (expand || collapse) {
                /** @type {?} */
                var rowID = this.cellID.rowID;
                grid.cdr.detectChanges();
                this.persistFocusedCell(rowID);
            }
            return;
        }
        _super.prototype.dispatchEvent.call(this, event);
    };
    /**
     * @protected
     * @param {?} rowID
     * @return {?}
     */
    IgxHierarchicalGridCellComponent.prototype.persistFocusedCell = /**
     * @protected
     * @param {?} rowID
     * @return {?}
     */
    function (rowID) {
        var _this = this;
        requestAnimationFrame(function () {
            // TODO: Test it out
            /** @type {?} */
            var cell = _this.gridAPI.get_cell_by_key(rowID, _this.column.field);
            if (cell) {
                cell.nativeElement.focus();
            }
        });
    };
    IgxHierarchicalGridCellComponent.decorators = [
        { type: Component, args: [{
                    changeDetection: ChangeDetectionStrategy.OnPush,
                    preserveWhitespaces: false,
                    selector: 'igx-hierarchical-grid-cell',
                    template: "<ng-template #defaultCell>\n    <div igxTextHighlight [cssClass]=\"highlightClass\" [activeCssClass]=\"activeHighlightClass\" [groupName]=\"gridID\"\n        [value]=\"formatter ? formatter(value) : column.dataType === 'number' ? (value | igxdecimal: grid.locale) : column.dataType === 'date' ? (value | igxdate: grid.locale) : value\"\n        [row]=\"rowData\" [column]=\"this.column.field\" [containerClass]=\"'igx-grid__td-text'\"\n        class=\"igx-grid__td-text\">{{ formatter ? formatter(value) : column.dataType === 'number' ? (value | igxdecimal:\n        grid.locale) : column.dataType === 'date' ? (value | igxdate: grid.locale) : value }}</div>\n</ng-template>\n<ng-template #inlineEditor let-cell=\"cell\">\n    <ng-container *ngIf=\"column.dataType === 'string'\">\n        <igx-input-group displayDensity=\"compact\">\n            <input igxInput [value]=\"editValue\" (input)=\"editValue = $event.target.value\" [igxFocus]=\"focused\" />\n        </igx-input-group>\n    </ng-container>\n    <ng-container *ngIf=\"column.dataType === 'number'\">\n        <igx-input-group displayDensity=\"compact\">\n            <input igxInput [value]=\"editValue\" (input)=\"editValue = $event.target.value\" [igxFocus]=\"focused\" type=\"number\">\n        </igx-input-group>\n    </ng-container>\n    <ng-container *ngIf=\"column.dataType === 'boolean'\">\n        <igx-checkbox (change)=\"editValue = $event.checked\" [value]=\"editValue\" [checked]=\"editValue\"\n            [igxFocus]=\"focused\" [disableRipple]=\"true\"></igx-checkbox>\n    </ng-container>\n    <ng-container *ngIf=\"column.dataType === 'date'\">\n        <igx-date-picker [style.width.%]=\"100\" [outlet]=\"grid.outletDirective\" mode=\"dropdown\" (onSelection)=\"editValue = $event\"\n            [locale]=\"grid.locale\" [value]=\"editValue\" [igxFocus]=\"focused\" [labelVisibility]=\"false\">\n        </igx-date-picker>\n    </ng-container>\n</ng-template>\n<ng-container *ngTemplateOutlet=\"template; context: context\">\n</ng-container>\n",
                    providers: [HammerGesturesManager]
                }] }
    ];
    /** @nocollapse */
    IgxHierarchicalGridCellComponent.ctorParameters = function () { return [
        { type: IgxGridSelectionService },
        { type: IgxGridCRUDService },
        { type: GridBaseAPIService },
        { type: IgxHierarchicalSelectionAPIService },
        { type: ChangeDetectorRef },
        { type: ElementRef },
        { type: NgZone },
        { type: HammerGesturesManager }
    ]; };
    IgxHierarchicalGridCellComponent.propDecorators = {
        onFocus: [{ type: HostListener, args: ['focus', ['$event'],] }],
        dispatchEvent: [{ type: HostListener, args: ['keydown', ['$event'],] }]
    };
    return IgxHierarchicalGridCellComponent;
}(IgxGridCellComponent));
export { IgxHierarchicalGridCellComponent };
if (false) {
    /**
     * @type {?}
     * @protected
     */
    IgxHierarchicalGridCellComponent.prototype.hSelection;
    /**
     * @type {?}
     * @protected
     */
    IgxHierarchicalGridCellComponent.prototype._rootGrid;
    /**
     * @type {?}
     * @protected
     */
    IgxHierarchicalGridCellComponent.prototype.selectionService;
    /**
     * @type {?}
     * @protected
     */
    IgxHierarchicalGridCellComponent.prototype.crudService;
    /** @type {?} */
    IgxHierarchicalGridCellComponent.prototype.gridAPI;
    /** @type {?} */
    IgxHierarchicalGridCellComponent.prototype.selection;
    /** @type {?} */
    IgxHierarchicalGridCellComponent.prototype.cdr;
    /**
     * @type {?}
     * @private
     */
    IgxHierarchicalGridCellComponent.prototype.helement;
    /**
     * @type {?}
     * @protected
     */
    IgxHierarchicalGridCellComponent.prototype.zone;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGllcmFyY2hpY2FsLWNlbGwuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vaWduaXRldWktYW5ndWxhci8iLCJzb3VyY2VzIjpbImxpYi9ncmlkcy9oaWVyYXJjaGljYWwtZ3JpZC9oaWVyYXJjaGljYWwtY2VsbC5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUN6RCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUNwRCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsVUFBVSxFQUFFLHVCQUF1QixFQUFFLFNBQVMsRUFDN0QsWUFBWSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUV6RCxPQUFPLEVBQUUsa0NBQWtDLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDakUsT0FBTyxFQUFFLHVCQUF1QixFQUFFLGtCQUFrQixFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFDeEYsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFFekQ7SUFPc0QsNERBQW9CO0lBS3RFLDBDQUNjLGdCQUF5QyxFQUN6QyxXQUErQixFQUNsQyxPQUF5RCxFQUN6RCxTQUE2QyxFQUM3QyxHQUFzQixFQUNyQixRQUFvQixFQUNsQixJQUFZLEVBQ3RCLFlBQW1DO1FBUnZDLFlBVVEsa0JBQU0sZ0JBQWdCLEVBQUUsV0FBVyxFQUFFLE9BQU8sRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsWUFBWSxDQUFDLFNBRTdGO1FBWFEsc0JBQWdCLEdBQWhCLGdCQUFnQixDQUF5QjtRQUN6QyxpQkFBVyxHQUFYLFdBQVcsQ0FBb0I7UUFDbEMsYUFBTyxHQUFQLE9BQU8sQ0FBa0Q7UUFDekQsZUFBUyxHQUFULFNBQVMsQ0FBb0M7UUFDN0MsU0FBRyxHQUFILEdBQUcsQ0FBbUI7UUFDckIsY0FBUSxH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QUFlLEVBQUUsdUJBQXVCLENBQUMsTUFBTTtvQkFDL0MsbUJBQW1CLEVBQUUsS0FBSztvQkFDMUIsUUFBUSxFQUFFLDRCQUE0QjtvQkFDdEMscS9EQUF1QztvQkFDdkMsU0FBUyxFQUFFLENBQUMscUJBQXFCLENBQUM7aUJBQ3JDOzs7O2dCQVRRLHVCQUF1QjtnQkFBRSxrQkFBa0I7Z0JBTDNDLGtCQUFrQjtnQkFJbEIsa0NBQWtDO2dCQUhsQyxpQkFBaUI7Z0JBQUUsVUFBVTtnQkFDWCxNQUFNO2dCQUl4QixxQkFBcUI7OzswQkF3RHpCLFlBQVksU0FBQyxPQUFPLEVBQUUsQ0FBQyxRQUFRLENBQUM7Z0NBMkJoQyxZQUFZLFNBQUMsU0FBUyxFQUFFLENBQUMsUUFBUSxDQUFDOztJQW1DdkMsdUNBQUM7Q0FBQSxBQXBIRCxDQU9zRCxvQkFBb0IsR0E2R3pFO1NBN0dZLGdDQUFnQzs7Ozs7O0lBRXpDLHNEQUFxQjs7Ozs7SUFDckIscURBQW9COzs7OztJQUdoQiw0REFBbUQ7Ozs7O0lBQ25ELHVEQUF5Qzs7SUFDekMsbURBQWdFOztJQUNoRSxxREFBb0Q7O0lBQ3BELCtDQUE2Qjs7Ozs7SUFDN0Isb0RBQTRCOzs7OztJQUM1QixnREFBc0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJZ3hHcmlkQ2VsbENvbXBvbmVudCB9IGZyb20gJy4uL2NlbGwuY29tcG9uZW50JztcbmltcG9ydCB7IEdyaWRCYXNlQVBJU2VydmljZSB9IGZyb20gJy4uL2FwaS5zZXJ2aWNlJztcbmltcG9ydCB7IENoYW5nZURldGVjdG9yUmVmLCBFbGVtZW50UmVmLCBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSwgQ29tcG9uZW50LFxuICAgICBPbkluaXQsIEhvc3RMaXN0ZW5lciwgTmdab25lIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBJZ3hIaWVyYXJjaGljYWxHcmlkQ29tcG9uZW50IH0gZnJvbSAnLi9oaWVyYXJjaGljYWwtZ3JpZC5jb21wb25lbnQnO1xuaW1wb3J0IHsgSWd4SGllcmFyY2hpY2FsU2VsZWN0aW9uQVBJU2VydmljZSB9IGZyb20gJy4vc2VsZWN0aW9uJztcbmltcG9ydCB7IElneEdyaWRTZWxlY3Rpb25TZXJ2aWNlLCBJZ3hHcmlkQ1JVRFNlcnZpY2UgfSBmcm9tICcuLi8uLi9jb3JlL2dyaWQtc2VsZWN0aW9uJztcbmltcG9ydCB7IEhhbW1lckdlc3R1cmVzTWFuYWdlciB9IGZyb20gJy4uLy4uL2NvcmUvdG91Y2gnO1xuXG5AQ29tcG9uZW50KHtcbiAgICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaCxcbiAgICBwcmVzZXJ2ZVdoaXRlc3BhY2VzOiBmYWxzZSxcbiAgICBzZWxlY3RvcjogJ2lneC1oaWVyYXJjaGljYWwtZ3JpZC1jZWxsJyxcbiAgICB0ZW1wbGF0ZVVybDogJy4vLi4vY2VsbC5jb21wb25lbnQuaHRtbCcsXG4gICAgcHJvdmlkZXJzOiBbSGFtbWVyR2VzdHVyZXNNYW5hZ2VyXVxufSlcbmV4cG9ydCBjbGFzcyBJZ3hIaWVyYXJjaGljYWxHcmlkQ2VsbENvbXBvbmVudCBleHRlbmRzIElneEdyaWRDZWxsQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcblxuICAgIHByb3RlY3RlZCBoU2VsZWN0aW9uO1xuICAgIHByb3RlY3RlZCBfcm9vdEdyaWQ7XG5cbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJvdGVjdGVkIHNlbGVjdGlvblNlcnZpY2U6IElneEdyaWRTZWxlY3Rpb25TZXJ2aWNlLFxuICAgICAgICBwcm90ZWN0ZWQgY3J1ZFNlcnZpY2U6IElneEdyaWRDUlVEU2VydmljZSxcbiAgICAgICAgcHVibGljIGdyaWRBUEk6IEdyaWRCYXNlQVBJU2VydmljZTxJZ3hIaWVyYXJjaGljYWxHcmlkQ29tcG9uZW50PixcbiAgICAgICAgcHVibGljIHNlbGVjdGlvbjogSWd4SGllcmFyY2hpY2FsU2VsZWN0aW9uQVBJU2VydmljZSxcbiAgICAgICAgcHVibGljIGNkcjogQ2hhbmdlRGV0ZWN0b3JSZWYsXG4gICAgICAgIHByaXZhdGUgaGVsZW1lbnQ6IEVsZW1lbnRSZWYsXG4gICAgICAgIHByb3RlY3RlZCB6b25lOiBOZ1pvbmUsXG4gICAgICAgIHRvdWNoTWFuYWdlcjogSGFtbWVyR2VzdHVyZXNNYW5hZ2VyXG4gICAgICAgICkge1xuICAgICAgICAgICAgc3VwZXIoc2VsZWN0aW9uU2VydmljZSwgY3J1ZFNlcnZpY2UsIGdyaWRBUEksIHNlbGVjdGlvbiwgY2RyLCBoZWxlbWVudCwgem9uZSwgdG91Y2hNYW5hZ2VyKTtcbiAgICAgICAgICAgIHRoaXMuaFNlbGVjdGlvbiA9IDxJZ3hIaWVyYXJjaGljYWxTZWxlY3Rpb25BUElTZXJ2aWNlPnNlbGVjdGlvbjtcbiAgICAgICAgIH1cblxuICAgIG5nT25Jbml0KCkge1xuICAgICAgICBzdXBlci5uZ09uSW5pdCgpO1xuICAgICAgICB0aGlzLl9yb290R3JpZCA9IHRoaXMuX2dldFJvb3RHcmlkKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBfZ2V0Um9vdEdyaWQoKSB7XG4gICAgICAgIGxldCBjdXJyR3JpZCA9IHRoaXMuZ3JpZDtcbiAgICAgICAgd2hpbGUgKGN1cnJHcmlkLnBhcmVudCkge1xuICAgICAgICAgICAgY3VyckdyaWQgPSBjdXJyR3JpZC5wYXJlbnQ7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGN1cnJHcmlkO1xuICAgIH1cblxuICAgIC8vIFRPRE86IEV4dGVuZCB0aGUgbmV3IHNlbGVjdGlvbiBzZXJ2aWNlIHRvIGF2b2lkIGNvbXBsZXRlIHRyYXZlcnNhbFxuICAgIF9jbGVhckFsbEhpZ2hsaWdodHMoKSB7XG4gICAgICAgIFt0aGlzLl9yb290R3JpZCwgLi4udGhpcy5fcm9vdEdyaWQuZ2V0Q2hpbGRHcmlkcyh0cnVlKV0uZm9yRWFjaChncmlkID0+IHtcbiAgICAgICAgICAgIGdyaWQuc2VsZWN0aW9uU2VydmljZS5jbGVhcigpO1xuICAgICAgICAgICAgZ3JpZC5zZWxlY3Rpb25TZXJ2aWNlLmFjdGl2ZUVsZW1lbnQgPSBudWxsO1xuICAgICAgICAgICAgZ3JpZC5uYXRpdmVFbGVtZW50LmNsYXNzTGlzdC5yZW1vdmUoJ2lneC1ncmlkX190ci0taGlnaGxpZ2h0ZWQnKTtcbiAgICAgICAgICAgIGdyaWQuaGlnaGxpZ2h0ZWRSb3dJRCA9IG51bGw7XG4gICAgICAgICAgICBncmlkLmNkci5tYXJrRm9yQ2hlY2soKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQGhpZGRlblxuICAgICAqIEBpbnRlcm5hbFxuICAgICAqL1xuICAgIEBIb3N0TGlzdGVuZXIoJ2ZvY3VzJywgWyckZXZlbnQnXSlcbiAgICBvbkZvY3VzKGV2ZW50KSB7XG4gICAgICAgIHRoaXMuX2NsZWFyQWxsSGlnaGxpZ2h0cygpO1xuICAgICAgICBjb25zdCBjdXJyZW50RWxlbWVudCA9IHRoaXMuZ3JpZC5uYXRpdmVFbGVtZW50O1xuICAgICAgICBsZXQgcGFyZW50R3JpZCA9IHRoaXMuZ3JpZDtcbiAgICAgICAgbGV0IGNoaWxkR3JpZDtcbiAgICAgICAgLy8gYWRkIGhpZ2hsaWdoIHRvIHRoZSBjdXJyZW50IGdyaWRcbiAgICAgICAgaWYgKHRoaXMuX3Jvb3RHcmlkLmlkICE9PSBjdXJyZW50RWxlbWVudC5pZCkge1xuICAgICAgICAgICAgY3VycmVudEVsZW1lbnQuY2xhc3NMaXN0LmFkZCgnaWd4LWdyaWRfX3RyLS1oaWdobGlnaHRlZCcpO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gYWRkIGhpZ2hsaWdoIHRvIHRoZSBjdXJyZW50IGdyaWRcbiAgICAgICAgd2hpbGUgKHRoaXMuX3Jvb3RHcmlkLmlkICE9PSBwYXJlbnRHcmlkLmlkKSB7XG4gICAgICAgICAgICBjaGlsZEdyaWQgPSBwYXJlbnRHcmlkO1xuICAgICAgICAgICAgcGFyZW50R3JpZCA9IHBhcmVudEdyaWQucGFyZW50O1xuXG4gICAgICAgICAgICBjb25zdCBwYXJlbnRSb3dJRCA9IHBhcmVudEdyaWQuaGdyaWRBUEkuZ2V0UGFyZW50Um93SWQoY2hpbGRHcmlkKTtcbiAgICAgICAgICAgIHBhcmVudEdyaWQuaGlnaGxpZ2h0ZWRSb3dJRCA9IHBhcmVudFJvd0lEO1xuICAgICAgICB9XG4gICAgICAgIHN1cGVyLm9uRm9jdXMoZXZlbnQpO1xuICAgIH1cblxuICAgIC8vIFRPRE86IFJlZmFjdG9yXG4gICAgLyoqXG4gICAgICogQGhpZGRlblxuICAgICAqIEBpbnRlcm5hbFxuICAgICAqL1xuICAgIEBIb3N0TGlzdGVuZXIoJ2tleWRvd24nLCBbJyRldmVudCddKVxuICAgIGRpc3BhdGNoRXZlbnQoZXZlbnQ6IEtleWJvYXJkRXZlbnQpIHtcbiAgICAgICAgY29uc3Qga2V5ID0gZXZlbnQua2V5LnRvTG93ZXJDYXNlKCk7XG4gICAgICAgIGlmIChldmVudC5hbHRLZXkpIHtcbiAgICAgICAgICAgIGNvbnN0IGdyaWQgPSB0aGlzLmdyaWRBUEkuZ3JpZDtcbiAgICAgICAgICAgIGNvbnN0IHN0YXRlID0gdGhpcy5ncmlkQVBJLmdyaWQuaGllcmFyY2hpY2FsU3RhdGU7XG4gICAgICAgICAgICBjb25zdCBjb2xsYXBzZSA9IHRoaXMucm93LmV4cGFuZGVkICYmIChrZXkgPT09ICdsZWZ0JyB8fCBrZXkgPT09ICdhcnJvd2xlZnQnIHx8IGtleSA9PT0gJ3VwJyB8fCBrZXkgPT09ICdhcnJvd3VwJyk7XG4gICAgICAgICAgICBjb25zdCBleHBhbmQgPSAhdGhpcy5yb3cuZXhwYW5kZWQgJiYgKGtleSA9PT0gJ3JpZ2h0JyB8fCBrZXkgPT09ICdhcnJvd3JpZ2h0JyB8fCBrZXkgPT09ICdkb3duJyB8fCBrZXkgPT09ICdhcnJvd2Rvd24nKTtcbiAgICAgICAgICAgIGlmIChjb2xsYXBzZSkge1xuICAgICAgICAgICAgICAgIGdyaWQuaGllcmFyY2hpY2FsU3RhdGUgPSBzdGF0ZS5maWx0ZXIodiA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB2LnJvd0lEICE9PSB0aGlzLnJvdy5yb3dJRDtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoZXhwYW5kKSB7XG4gICAgICAgICAgICAgICAgc3RhdGUucHVzaCh7IHJvd0lEOiB0aGlzLnJvdy5yb3dJRCB9KTtcbiAgICAgICAgICAgICAgICBncmlkLmhpZXJhcmNoaWNhbFN0YXRlID0gWy4uLnN0YXRlXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChleHBhbmQgfHwgY29sbGFwc2UpIHtcbiAgICAgICAgICAgICAgICBjb25zdCByb3dJRCA9IHRoaXMuY2VsbElELnJvd0lEO1xuICAgICAgICAgICAgICAgIGdyaWQuY2RyLmRldGVjdENoYW5nZXMoKTtcbiAgICAgICAgICAgICAgICB0aGlzLnBlcnNpc3RGb2N1c2VkQ2VsbChyb3dJRCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgc3VwZXIuZGlzcGF0Y2hFdmVudChldmVudCk7XG4gICAgfVxuXG4gICAgcHJvdGVjdGVkIHBlcnNpc3RGb2N1c2VkQ2VsbChyb3dJRCkge1xuICAgICAgICByZXF1ZXN0QW5pbWF0aW9uRnJhbWUoKCkgPT4ge1xuICAgICAgICAgICAgLy8gVE9ETzogVGVzdCBpdCBvdXRcbiAgICAgICAgICAgIGNvbnN0IGNlbGwgPSB0aGlzLmdyaWRBUEkuZ2V0X2NlbGxfYnlfa2V5KHJvd0lELCB0aGlzLmNvbHVtbi5maWVsZCk7XG4gICAgICAgICAgICBpZiAoY2VsbCkge1xuICAgICAgICAgICAgICAgIGNlbGwubmF0aXZlRWxlbWVudC5mb2N1cygpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG59XG4iXX0=